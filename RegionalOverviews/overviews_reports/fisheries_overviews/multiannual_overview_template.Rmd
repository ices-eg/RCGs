---
title: "Multiannual overview template"
author: "RCG ISSG Regional overviews"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r ReadData, echo=FALSE, message=FALSE}
library(dplyr)
library(knitr)
library(tidyr)
library(kableExtra)
library(ggplot2)
library(data.table)
library(directlabels)
#Choose RCG. Options: BA, NA, NSEA
RCG <- "NSEA"
years <- c(2015,2016,2017,2018,2019)
load(paste("Q:\\mynd\\RDB\\RDB_fisheries_overviews\\RDB_RCG_",RCG,"_CE_2009_2019_prepared_20200616.Rdata", sep=""))
load(paste("Q:\\mynd\\RDB\\RDB_fisheries_overviews\\RDB_RCG_",RCG,"_CL_2009_2019_prepared_20200616.Rdata", sep=""))
CE_years <- ce_rcg[ce_rcg$Year %in% years,]
CL_years <- cl_rcg[cl_rcg$Year %in% years,]

DAS_country <- CE_years %>%
    group_by(Year, FlagCountry, FishingActivityLvl5) %>%
    summarise(DaysAtSea=sum(DaysAtSea))
DAS_country$gear <- substr(DAS_country$FishingActivityLvl5,1,3)

Landings_country <- CL_years %>%
  group_by(Year, FlagCountry, FishingActivityLvl5) %>%
  summarise(LandingWeight_ton=sum(LandingWeight_ton))
Landings_country$gear <- substr(Landings_country$FishingActivityLvl5,1,3)

```


**RCG Multiannual overviews**

**CE and CL data Data**

Text describing the input data....

**Text describing figures 1**

## Figures 1: Effort {.tabset}

### Days at sea Total fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
DAS_total <- CE_years %>%
    group_by(Year, FlagCountry) %>%
    summarise(DaysAtSea=sum(DaysAtSea))


ggplot(data=DAS_total, aes(Year, round(DaysAtSea/1000,0), colour=FlagCountry)) + 
  geom_line() +
  scale_colour_discrete(guide = 'none') +
  geom_dl(aes(label = FlagCountry), method = list(dl.trans(x = x + 0.1), "last.points", cex = 0.7))+
  labs(title=paste("Days at sea by country Total fisheries -", RCG), x="year", y="Days at sea (thousands)")+
  theme(axis.text.x = element_text(size=8), plot.title=element_text(size=8), axis.title = element_text(size=8))

```

### Days at sea Bottom trawl fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
DAS_country_OTB <- droplevels(DAS_country[!is.na(DAS_country$DaysAtSea) & DAS_country$gear %in% c('OTB','PTB','OTT','TBB'),])

ggplot(data=DAS_country_OTB, aes(Year, DaysAtSea, colour=FlagCountry)) +
  geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Days at sea by country Bottom trawl fisheries -", RCG), x="year", y="Days at sea")+
  theme(legend.position="bottom", axis.text.x = element_text(size=8), plot.title=element_text(size=8), axis.title = element_text(size=8),
        axis.text.x.bottom  = element_text(angle = 90)) 

```

### Days at sea Pelagic trawl fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
DAS_country_OTM <- droplevels(DAS_country[!is.na(DAS_country$DaysAtSea) & DAS_country$gear %in% c('OTM','PTM'),])
  
ggplot(data=DAS_country_OTM, aes(Year, DaysAtSea, colour=FlagCountry)) +
  geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Days at sea by country Pelagic trawl fisheries -", RCG), x="year", y="Days at sea")+
  theme(legend.position="bottom",axis.text.x = element_text(size=8), plot.title=element_text(size=8), axis.title = element_text(size=8), 
        axis.text.x.bottom  = element_text(angle = 90))

```

### Days at sea Surrounding nets fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
DAS_country_SNet <- DAS_country[!is.na(DAS_country$DaysAtSea) & DAS_country$gear %in% c('LA_','PS_') ,]
ggplot(data=DAS_country_SNet, aes(Year, DaysAtSea, colour=FlagCountry)) +
  geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Days at sea by country Surrounding nets fisheries -", RCG), x="year", y="Days at sea")+
  theme(legend.position="bottom",axis.text.x = element_text(size=8), plot.title=element_text(size=8), axis.title = element_text(size=8), 
        axis.text.x.bottom  = element_text(angle = 90))
```

### Days at sea Seine fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
DAS_country_S <- droplevels(DAS_country[!is.na(DAS_country$DaysAtSea) & DAS_country$gear %in% c('SB_','SV_','SSC','SDN','SPR') ,])
ggplot(data=DAS_country_S, aes(Year, DaysAtSea, colour=FlagCountry)) +
  geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Days at sea by country Seine fisheries -", RCG), x="year", y="Days at sea")+
  theme(legend.position="bottom",axis.text.x = element_text(size=8), plot.title=element_text(size=8), axis.title = element_text(size=8), 
        axis.text.x.bottom  = element_text(angle = 90))
```

### Days at sea Net fisheries

```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
DAS_country_N <- droplevels(DAS_country[!is.na(DAS_country$DaysAtSea) & DAS_country$gear %in% c('GNS','GND','GTR'),])
ggplot(data=DAS_country_N, aes(Year, DaysAtSea, colour=FlagCountry)) +
  geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Days at sea by country Net fisheries -", RCG), x="year", y="Days at sea")+
  theme(legend.position="bottom",axis.text.x = element_text(size=8), plot.title=element_text(size=8), axis.title = element_text(size=8),
        axis.text.x.bottom  = element_text(angle = 90))
```

### Days at sea Longline fisheries

```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
DAS_country_LL <- droplevels(DAS_country[!is.na(DAS_country$DaysAtSea) & DAS_country$gear %in% c('LLS','LLD'),])
ggplot(data=DAS_country_LL, aes(Year, DaysAtSea, colour=FlagCountry)) +
  geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Days at sea by country Longline fisheries -", RCG), x="year", y="Days at sea")+
  theme(legend.position="bottom",axis.text.x = element_text(size=8), plot.title=element_text(size=8), axis.title = element_text(size=8),
        axis.text.x.bottom  = element_text(angle = 90))
```

### Days at sea Rods and lines fisheries

```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
DAS_country_RL <- droplevels(DAS_country[!is.na(DAS_country$DaysAtSea) & DAS_country$gear %in% c("LHP",'LHM','LTL'),])
ggplot(data=DAS_country_RL, aes(Year, DaysAtSea, colour=FlagCountry)) +
  geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Days at sea by country Rods and lines fisheries -", RCG), x="year", y="Days at sea")+
  theme(legend.position="bottom",axis.text.x = element_text(size=8), plot.title=element_text(size=8), axis.title = element_text(size=8),
        axis.text.x.bottom  = element_text(angle = 90))
```


### Days at sea Dredge fisheries

```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
DAS_country_D <- droplevels(DAS_country[!is.na(DAS_country$DaysAtSea) & DAS_country$gear %in% c("DRB","HMD"),])
ggplot(data=DAS_country_D, aes(Year, DaysAtSea, colour=FlagCountry)) +
  geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Days at sea by country Dredge fisheries -", RCG), x="year", y="Days at sea")+
  theme(legend.position="bottom",axis.text.x = element_text(size=8), plot.title=element_text(size=8), axis.title = element_text(size=8),
        axis.text.x.bottom  = element_text(angle = 90))
```

### Days at sea Traps fisheries

```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
DAS_country_T <- droplevels(DAS_country[!is.na(DAS_country$DaysAtSea) & DAS_country$gear %in% c("FPO","FPN","FYK"),])
ggplot(data=DAS_country_T, aes(Year, DaysAtSea, colour=FlagCountry)) +
  geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Days at sea by country Pots and Traps fisheries -", RCG), x="year", y="Days at sea")+
  theme(legend.position="bottom",axis.text.x = element_text(size=8), plot.title=element_text(size=8), axis.title = element_text(size=8),
        axis.text.x.bottom  = element_text(angle = 90))
```

## {-}



**Text describing figures 2

## Figures 2 Landings {.tabset}

### Landings Total fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}

Landings_total <- CL_years %>%
  group_by(Year, FlagCountry) %>%
  summarise(LandingWeight_ton=sum(LandingWeight_ton))

ggplot(data=Landings_total, aes(Year, round(LandingWeight_ton/1000,0), colour=FlagCountry)) +
  geom_line() +
  scale_colour_discrete(guide = 'none') +
  geom_dl(aes(label = FlagCountry), method = list(dl.trans(x = x + 0.1), "last.points", cex = 0.7))+
  labs(title=paste("Landings by country Total fisheries -", RCG), x="year", y="Landings (thousand ton)")+
  theme(axis.text.x = element_text(size=8), plot.title=element_text(size=8), axis.title = element_text(size=8))
```

### Landings Bottom trawl fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
Landings_country_OTB <- droplevels(Landings_country[!is.na(Landings_country$LandingWeight_ton) & Landings_country$gear %in% c('OTB','PTB','OTT','TBB'),])
ggplot(data=Landings_country_OTB, aes(Year, LandingWeight_ton, colour=FlagCountry)) +
  geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Landings by country Bottom trawls -", RCG), x="year", y="Landings (ton)")+
  theme(legend.position="bottom",axis.text.x = element_text(size=8), plot.title=element_text(size=8), axis.title = element_text(size=8),
        axis.text.x.bottom  = element_text(angle = 90))
```

### Landings Pelagic trawl fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
Landings_country_OTM <- droplevels(Landings_country[!is.na(Landings_country$LandingWeight_ton) & Landings_country$gear %in% c("OTM","PTM"),])
ggplot(data=Landings_country_OTM, aes(Year, LandingWeight_ton, colour=FlagCountry)) +
  geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Landings by country Pelagic trawls -", RCG), x="year", y="Landings (ton)")+
  theme(legend.position="bottom",axis.text.x = element_text(size=8), plot.title=element_text(size=8), axis.title = element_text(size=8), 
        axis.text.x.bottom  = element_text(angle = 90))
```

### Landings Surrounding nets fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
Landings_country_SNet <- droplevels(Landings_country[!is.na(Landings_country$LandingWeight_ton) & Landings_country$gear %in% c("LA_","PS_"),])
ggplot(data=Landings_country_SNet, aes(Year, LandingWeight_ton, colour=FlagCountry)) +
  geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Landings by country Surrounding nets -", RCG), x="year", y="Landings (ton)")+
  theme(legend.position="bottom",axis.text.x = element_text(size=8), plot.title=element_text(size=8), axis.title = element_text(size=8), 
        axis.text.x.bottom  = element_text(angle = 90))
```

### Landings Seine fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
Landings_country_S <- Landings_country[Landings_country$gear %in% c("SDN","SSC","SB_"),]
ggplot(data=Landings_country_S, aes(Year, LandingWeight_ton, colour=FlagCountry)) +
  geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Landings by country Seine -", RCG), x="year", y="Landings (ton)")+
  theme(legend.position="bottom",axis.text.x = element_text(size=8), plot.title=element_text(size=8), axis.title = element_text(size=8), 
        axis.text.x.bottom  = element_text(angle = 90))
```

### Landings Net fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
Landings_country_N <- droplevels(Landings_country[!is.na(Landings_country$LandingWeight_ton) & Landings_country$gear %in% c('GNS','GND','GTR'),])
ggplot(data=Landings_country_N, aes(Year, LandingWeight_ton, colour=FlagCountry)) +
  geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Landings by country Nets -", RCG), x="year", y="Landings (ton)")+
  theme(legend.position="bottom",axis.text.x = element_text(size=8), plot.title=element_text(size=8), axis.title = element_text(size=8),
        axis.text.x.bottom  = element_text(angle = 90))
```

### Landings Longline fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
Landings_country_LL <- droplevels(Landings_country[!is.na(Landings_country$LandingWeight_ton) & Landings_country$gear %in% c('LLS','LLD'),])
ggplot(data=Landings_country_LL, aes(Year, LandingWeight_ton, colour=FlagCountry)) +
  geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Landings by country Longline -", RCG), x="year", y="Landings (ton)")+
  theme(legend.position="bottom",axis.text.x = element_text(size=8), plot.title=element_text(size=8),
        axis.title = element_text(size=8), axis.text.x.bottom  = element_text(angle = 90))
```

### Landings Rods and lines fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
Landings_country_RL <- droplevels(Landings_country[!is.na(Landings_country$LandingWeight_ton) & Landings_country$gear %in% c('LHP','LHM','LTL'),])
ggplot(data=Landings_country_RL, aes(Year, LandingWeight_ton, colour=FlagCountry)) +
  geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Landings by country Rods and lines fisheries -", RCG), x="year", y="Landings (ton)")+
  theme(legend.position="bottom",axis.text.x = element_text(size=8), plot.title=element_text(size=8),
        axis.title = element_text(size=8), axis.text.x.bottom  = element_text(angle = 90))
```

### Landings Dredge fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
Landings_country_D <- droplevels(Landings_country[!is.na(Landings_country$LandingWeight_ton) & Landings_country$gear %in% c("DRB","HMD"),])
ggplot(data=Landings_country_D, aes(Year, LandingWeight_ton, colour=FlagCountry)) +
  geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Landings by country Dredges -", RCG), x="year", y="Landings (ton)")+
  theme(legend.position="bottom",axis.text.x = element_text(size=8), plot.title=element_text(size=8), axis.title = element_text(size=8),
        axis.text.x.bottom  = element_text(angle = 90))
```

### Landings Pots and Traps fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
Landings_country_T <- droplevels(Landings_country[!is.na(Landings_country$LandingWeight_ton) & Landings_country$gear %in% c('FPO','FPN','FYK'),])
ggplot(data=Landings_country_T, aes(Year, LandingWeight_ton, colour=FlagCountry)) +
  geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Landings by country Traps -", RCG), x="year", y="Landings (ton)")+
  theme(legend.position="bottom",axis.text.x = element_text(size=8), plot.title=element_text(size=8), axis.title = element_text(size=8),
        axis.text.x.bottom  = element_text(angle = 90))
```

## {-}



**Text describing figures 3

## Figures 3: Landings {.tabset}
### 1 Total landings top 10 species - line  
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
CL_years$Species1 <- as.character(CL_years$Species)
top10_species <- CL_years %>%
  group_by(Species1) %>%
  summarise(lwTot=sum(LandingWeight_ton)) %>%
  arrange(desc(lwTot)) %>%
  top_n(10)
top10_species$Top10species <- "X"
landings_sp <- left_join(CL_years,top10_species,by="Species1")
landings_sp$topSpecies <- ifelse(is.na(landings_sp$Top10species),"Other species",landings_sp$Species1)

landings_sp_sum <- landings_sp %>%
  group_by(Year, topSpecies) %>%
  summarise(Landing_ton=sum(LandingWeight_ton))

ggplot(data=landings_sp_sum, aes(Year, Landing_ton, colour=topSpecies)) +
  geom_line() +
  labs(title=paste("Landings by top 10 species -", RCG), x="year", y="Landings (ton)")+
  theme(axis.text.x = element_text(size=8), plot.title=element_text(size=8), axis.title = element_text(size=8))

```

### 2 Total landings top 10 species - stacked bar   
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
CL_years$Species1 <- as.character(CL_years$Species)
top10_species <- CL_years %>%
  group_by(Species1) %>%
  summarise(lwTot=sum(LandingWeight_ton)) %>%
  arrange(desc(lwTot)) %>%
  top_n(10)
top10_species$Top10species <- "X"
landings_sp <- left_join(CL_years,top10_species,by="Species1")
landings_sp$topSpecies <- ifelse(is.na(landings_sp$Top10species),"Other species",landings_sp$Species1)

landings_sp_sum <- landings_sp %>%
  group_by(Year, topSpecies) %>%
  summarise(Landing_ton=sum(LandingWeight_ton))

ggplot(data=landings_sp_sum, aes(x=Year, y=Landing_ton, fill=topSpecies)) +
  geom_bar(position="stack", stat="identity") +
  labs(title=paste("Landings by top 10 species -", RCG), x="year", y="Landings (ton)")+
  theme(axis.text.x = element_text(size=8), plot.title=element_text(size=8), axis.title = element_text(size=8))

```


### 3 Total landings top 10 species - stacked bar pct
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
CL_years$Species1 <- as.character(CL_years$Species)
top10_species <- CL_years %>%
  group_by(Species1) %>%
  summarise(lwTot=sum(LandingWeight_ton)) %>%
  arrange(desc(lwTot)) %>%
  top_n(10)
top10_species$Top10species <- "X"
landings_sp <- left_join(CL_years,top10_species,by="Species1")
landings_sp$topSpecies <- ifelse(is.na(landings_sp$Top10species),"Other species",landings_sp$Species1)

landings_sp_sum <- landings_sp %>%
  group_by(Year, topSpecies) %>%
  summarise(Landing_ton=sum(LandingWeight_ton))

ggplot(data=landings_sp_sum, aes(x=Year, y=Landing_ton, fill=topSpecies)) +
  geom_bar(position="fill", stat="identity") +
  labs(title=paste("Landings by top 10 species -", RCG), x="year", y="Landings (ton)")+
  theme(axis.text.x = element_text(size=8), plot.title=element_text(size=8), axis.title = element_text(size=8))

```

###  Landings by country top 10 species - stacked bar pct
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
CL_years$Species1 <- as.character(CL_years$Species)
top10_species <- CL_years %>%
  group_by(Species1) %>%
  summarise(lwTot=sum(LandingWeight_ton)) %>%
  arrange(desc(lwTot)) %>%
  top_n(10)
top10_species$Top10species <- "X"
landings_sp <- left_join(CL_years,top10_species,by="Species1")
landings_sp$topSpecies <- ifelse(is.na(landings_sp$Top10species),"Other species",landings_sp$Species1)

landings_sp_sum <- landings_sp %>%
  group_by(Year, FlagCountry, topSpecies) %>%
  summarise(Landing_ton=sum(LandingWeight_ton))

ggplot(data=landings_sp_sum, aes(x=Year, y=Landing_ton, fill=FlagCountry)) +
  geom_bar(position="fill", stat="identity") +
  theme_bw() +
  facet_wrap(~topSpecies)+
  labs(title=paste("Landings by top 10 species -", RCG), x="year", y="Landings (ton)")+
  theme(axis.text.x = element_text(size=8), plot.title=element_text(size=8), axis.title = element_text(size=8),
        axis.text.x.bottom  = element_text(angle = 90))

```

## {-}

**Text describing stocks

## Stock {.tabset}
### Stock|Country|Metier|Landings
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}

print('table')

```
### Stock|Country|Metier|Landings
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
print('graph')

```

### Stock|Country|Metier|Effort
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
print('graph')

```
## {-}
