```{r title, include = F}
RCG <- "RCG_BA" # RCG_NA, RCG_BA or RCG_NSEA
years <- c(2016,2017,2018,2019,2020,2021) 
if (RCG == "RCG_NA") {
  front_title <- paste("RDB Catch and Effort Overview North Atlantic ", sep = "")
  title_stock <- c('North Atlantic region')
 # warning_stock<-c('')
 # warning_uk<-c("Paragraph UK/Brexit") - no UK data is reported
} else if (RCG == "RCG_BA") {
  front_title <- paste("RDB Catch and Effort Overview Baltic ", sep = "")
  title_stock <- c('Baltic region')
 # warning_uk<-c("")
 # warning_stock<-c("Moreover some countries reported landings of herring from area 27.3.d.28. The group was not able to identify whether it was stock 'her.27.28' or 'her.27.25-2932'. As a temporary solution, all these landings were assigned to 'her.27.25-2932'.") - corrected after RCG 2021
} else if (RCG == "RCG_NSEA") {
  front_title <- paste("RDB Catch and Effort Overview North Sea and Eastern Arctic ", sep = "")
  title_stock <- c('North Sea and Eastern Arctic regions')
 # warning_stock<-c('')
 # warning_uk<-c("")
}
```


---
title: `r front_title`
author: "RCG ISSG Regional overviews"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: html_document
---


<style type="text/css">

h1.title {
  font-size: 20px;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

```{r, echo=FALSE}
if (RCG == "RCG_NA") {
  htmltools::img(src = knitr::image_uri(file.path("../../overviews_shiny/www/logo RCG NA NS_EA.png")), 
               alt = 'logo', 
               style = 'position:absolute; top:0; right:0; padding:10px;',width="300px", height="100px")
} else if (RCG == "RCG_BA") {
  htmltools::img(src = knitr::image_uri(file.path("../../overviews_shiny/www/logo RCG BALTIC.PNG")), 
               alt = 'logo', 
               style = 'position:absolute; top:0; right:0; padding:10px;',width="300px", height="100px")
} else if (RCG == "RCG_NSEA") {
  htmltools::img(src = knitr::image_uri(file.path("../../overviews_shiny/www/logo RCG NA NS_EA.png")), 
               alt = 'logo', 
               style = 'position:absolute; top:0; right:0; padding:10px;',width="300px", height="100px")
}
```


```{r ReadData, echo=FALSE, message=FALSE, warning=FALSE}
library(dplyr)
library(knitr)
library(tidyr)
library(kableExtra)
library(ggplot2)
library(data.table)
library(directlabels)
library(flextable)
library(scales)
library(DT)
library(gridExtra)
library(grid)
library(plotly)
source("../../funs/fun_theme_flextable.r")

#years <- c(2015,2016,2017,2018,2019)
year <- 2021 # 2021 OK for the fleet register
#data_dir <- paste("../../data/002_prepared/RCG_", RCG, "/", sep = '')
#data_dir <- paste("D:/Do przegrania na PC/IntersessionalWork/RCGs Data/2020 data/RCG_", RCG, "/", sep = '') #Marta's path
#data_dir <- paste("Q:/mynd/RDB/RDB_fisheries_overviews/data/002_prepared/RCG_", RCG, "/", sep = '')
 data_dir <- paste("C:\\Use\\0_Lucia\\6_Working groups\\RCG_ISSG\\ISSG Catch and Effort Overview\\ISSG_overviews\\RDB_Data\\2021\\", RCG, "/", sep = '') # Lucia's path PC

# data_dir <- paste("D:/Documents/PNAB/2022/000_RCG_InterssessionalWork/ISSG_Catch_Effort_Sampling_overviews/ISSG_overviews/RegionalOverviews/input_data/2021/", RCG, "/", sep = '') # Ana's path PC
```



```{r ReadData2, echo=FALSE, message=FALSE, warning=FALSE}
 load(paste(data_dir,"RDB_",RCG,"_CE_2009_2021_prepared_20220422.Rdata", sep=""))
 load(paste(data_dir,"RDB_",RCG,"_CL_2009_2021_prepared_20220422.Rdata", sep=""))

#Nuno file with stocks
Def_stock<-read.delim("../../data/aux_stocks.txt")

CE_years <- ce_rcg[ce_rcg$Year %in% years,]
CL_years <- cl_rcg[cl_rcg$Year %in% years,]

DAS_country <- CE_years %>%
    group_by(Year, FlagCountry, FishingActivityLvl5) %>%
    summarise(DaysAtSea=sum(DaysAtSea))
DAS_country$gear <- substr(DAS_country$FishingActivityLvl5,1,3)

Landings_country <- CL_years %>%
  group_by(Year, FlagCountry, FishingActivityLvl5) %>%
  summarise(LandingWeight_ton=sum(LandingWeight_ton))
Landings_country$gear <- substr(Landings_country$FishingActivityLvl5,1,3)

#fleet register
# functions and packages
	require(data.table)

	fleetreg<-data.table()

		# based on full history
	
		 # dir<-paste("D:/Documents/PNAB/2022/000_RCG_InterssessionalWork/ISSG_Catch_Effort_Sampling_overviews/ISSG_overviews/RegionalOverviews/data/fleet_reg/output/", year,"/", sep = "") ## PC
	
		  dir <- paste("C:/Use/0_GitHub/RCGs/RegionalOverviews/data/fleet_reg/output/", year, "/", sep = '') # Lucia's path PC

		
	for (ctry in c("BEL","DEU","DNK","ESP","EST","FIN","FRA","IRL","LTU","LVA","NLD","POL","PRT","SWE")) # no data for "GBR"
		{
		# print(ctry)
		fleetreg<-rbind(fleetreg,fread(paste(dir,ctry,"_export.csv", sep = ""), sep = ";",stringsAsFactors=FALSE, verbose=FALSE))
		}	

	 		# subsets data
		fleetreg<-fleetreg[License_Ind=="Y",]
			# creates status date date and combines data
		fleetreg$V2021<-0
		fleetreg$V2020<-0
		fleetreg$V2019<-0
		fleetreg$V2018<-0
		fleetreg$V2017<-0
		fleetreg$V2016<-0

		fleetreg[Event_Start_Date<=20210101 & Event_End_Date>=20210101,V2021:=20210101,]
		fleetreg[Event_Start_Date<=20200101 & Event_End_Date>=20200101,V2020:=20200101,]
		fleetreg[Event_Start_Date<=20190101 & Event_End_Date>=20190101,V2019:=20190101,]		
		fleetreg[Event_Start_Date<=20180101 & Event_End_Date>=20180101,V2018:=20180101,]
		fleetreg[Event_Start_Date<=20170101 & Event_End_Date>=20170101,V2017:=20170101,]
		fleetreg[Event_Start_Date<=20160101 & Event_End_Date>=20160101,V2016:=20160101,]
	
		fleetreg$Status_date<-0
	
		target_cols<-c("Country_Code","CFR","Event_Code","Event_Start_Date","Event_End_Date","License_Ind","Loa","Ton_Gt","Ton_Oth","Ton_Gts","Power_Main","Power_Aux","Status_date")
	
		df2021<-as.data.frame(fleetreg[V2021==20210101,])
		df2021$Status_date<-2021
		df2021<-df2021[target_cols]
		
		df2020<-as.data.frame(fleetreg[V2020==20200101,])
		df2020$Status_date<-2020
		df2020<-df2020[target_cols]
		
		df2019<-as.data.frame(fleetreg[V2019==20190101,])
		df2019$Status_date<-2019
		df2019<-df2019[target_cols]
		
		df2018<-as.data.frame(fleetreg[V2018==20180101,])
		df2018$Status_date<-2018
		df2018<-df2018[target_cols]
			
		df2017<-as.data.frame(fleetreg[V2017==20170101,])
		df2017$Status_date<-2017
		df2017<-df2017[target_cols]

		df2016<-as.data.frame(fleetreg[V2016==20160101,])
		df2016$Status_date<-2016
		df2016<-df2016[target_cols]
		
		fleetreg<-as.data.table(rbind(df2021, df2020, df2019, df2018, df2017, df2016))
			
		# a few formats and quality checks
		fleetreg$Power_Main<-as.numeric(fleetreg$Power_Main)
		fleetreg$Ton_Gt<-as.numeric(fleetreg$Ton_Gt)
		# QCA: should yield 0
#    	sum(is.na(fleetreg$Power_Main))
# 		sum(is.na(fleetreg$Ton_Gt))
		
## For the harmonization of the country colours between Annual and Multiannual overviews		
colour_table <-
  read.table(
    #"D:/Documents/PNAB/2022/000_RCG_InterssessionalWork/ISSG_Catch_Effort_Sampling_overviews/ISSG_overviews/RegionalOverviews//data/aux_colours.txt",
    "C:/Use/0_GitHub/RCGs/RegionalOverviews/data/aux_colours.txt", # lucia's PC
    header = T,
    sep = "\t",
    colClasses = "character",
    na.strings = "",
    comment.char = ""
  )
aux_colours_ggplot =  colour_table[,c("Country","colour5")]
		  		
```

**Disclaimer**

The tables and figures of the overviews presented in this document are made for the coordination of EU regional fisheries data collection purposes and are not designed for any other use. Data used for producing the outputs are extracted from the Regional Database (RDB) and EU Fleet Register. Dates of data extractions are stated in Appendix A. Due to different aggregations and reporting authorities, data can differ from those used e.g. for assessments or technical reports.

Member States (MS) are responsible for uploading latest data and the latest year should be viewed as provisional. Data can be resubmitted by a MS for more than one previous year so there might be differences in earlier year reports, if countries update back in time. Responsibility for the quality of the data and comparability to other data sources lies with the MS that provided these data. The upload logs presented by MS regarding the data submitted to RDB can be found in the Share Point for Intersessional Work, together with the data.

The respective scripts and calculations used for data displaying are publicly available via the RCG GitHub (https://github.com/ices-eg/RCGs) and subject to change as the work of the group progresses.



# **RCG Multiannual overviews**

The present Catch and Effort Overview displays summary information on EU commercial landings (CL) and fishing effort (CE) statistics included in the Regional Data Base (RDB), which is used to store detailed commercial fisheries and sampling data. These multiannual reports are important in the way they allow the analyses of the variation in time of the fleets, landings volume and composition and fishing effort of the European fisheries by region.

Before the subgroup on catch, effort and sampling overviews was set up, the different RCGs conducted data analysis and overviews separately with minimal exchange, resulting in redundancies and efficiency loss. Furthermore, a substantial part of the work was being carried out during the RCG meetings themselves and so not readily available to inform RCG preparation and meeting discussions. This group was established to streamline and facilitate the work on the fisheries and sampling data of the MS and prepare data overviews in advance of the RCG meetings. 

The RDB is hosted at the International Council for Exploration of the Sea (ICES) and its data is property of EU Member States with usage governed by the [Data use license for the Regional Database (RDB)](https://ices-library.figshare.com/articles/report/Data_use_license_for_the_Regional_Database_RDB_and_Regional_Database_and_Estimation_System_RDBES_/22188157/1). 

It’s a regionally coordinated database platform covering fisheries  by region (e.g. North Atlantic Ocean, North Sea, Baltic Sea) and is a main resource used by the Regional Coordination Groups to coordinate data collection of EU fisheries. This database aims also:
1)	To ensure that data can be made available for the coordination of regional fisheries data sampling plans, in particular for the DCF Regional Coordination Groups (RCGs);
2)	To provide a regional estimation system such that statistical estimates of quantities of interest can be produced from sample data, in order to deliver data for ICES stock assessments and advice,
3)	To serve and facilitate the production of fisheries management advice and status reports,
4)	To increase the awareness of fisheries data collected by the users of the RDB and the overall usage of these data.
5)	To address fishery management needs related to the European Union Common Fisheries

However, it has been recognized for many years the need to have a new version of the RDB which would also store details about how the sampling was performed and enable statistical estimations to be made. The incoming Regional DataBase and Estimation System (RDBES) is taking the place of the RDB to improve those aspects. It is expected that RDBES will fill the gaps of the RDB and, in the near future, will also allow the improvement of the information reported in these fisheries overviews.


##	Overall fleet evolution (All RCGs){.tabset}

The tables included in this section present a summary of the information on licensed vessels from the European Union Fleet Register in the period 2016-2021.

### Number of vessels
**Table 1.** Number of vessels with fishing license, by flag country in the EU vessel register.
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
res_fleetreg<-tapply(fleetreg$Country_Code,list(fleetreg$Country_Code,fleetreg$Status_date),length)
ft<-theme_flextable(res_fleetreg)
ft

```

### Power
**Table 2.** Power (`1000*`kW) of the vessels with fishing license, by flag country in the EU vessel register.
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
res_fleetreg_pwr<-round(tapply(fleetreg$Power_Main, list(fleetreg$Country_Code, fleetreg$Status_date), sum)/1000,1)
ft<-theme_flextable(res_fleetreg_pwr)
ft
```

### Gross tonnage
**Table 3.** Gross Tonnage (`1000*`GT) of the vessels with fishing license, by flag country in the EU vessel register.
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
res_fleetreg_gt <- round(tapply(fleetreg$Ton_Gt, list(fleetreg$Country_Code, fleetreg$Status_date), sum)/1000,1)
ft<-theme_flextable(res_fleetreg_gt)
ft
```

## {-}

##	RDB information for EU countries

The figures below are based on RDB effort (CE) and landings (CL) data. 

## Effort {.tabset}

The annual fishing effort in number of days at sea for the `r title_stock`, is presented in the interactive figures below. Since this is not a mandatory field in the reported CE data, there is some missing information for some countries/years (see Table 4). 
The first panel ('Days at sea Total fisheries') compiles the annual total fishing effort by flag country. 
The following panels present the annual fishing effort by flag country for the different fisheries ("Fishing activity level 5"). Fisheries are grouped according to métier level 3 definition: the "Pelagic trawl fisheries" include the mid-water otter trawl (OTM) and pelagic pair trawl (PTM); the "Surrounding nets fisheries" include the lampara nets (LA) and purse seine (PS); the "Seine fisheries" include the beach and boat seines (SB and SV), the fly shooting seine (SSC), anchored seine (SDN) and pair seine (SPR); the "Net fisheries" include set gillnet (GNS), driftnet (GND) and trammel net (GTR); the "Longline fisheries" include set and drifting longlines (LLS and LLD); the "Rods and lines fisheries" include the hand and pole lines (LHP and LHM) and the trolling lines (LTL); the "Dredge fisheries" include boat and hand dredges (DRB and HMD). In the case of the bottom trawls and traps, the panels are presented by metier level 4 due to the higher number of metiers level 5 present in these groups: "Bottom otter trawl fisheries" (OTB); "Multi-rig otter trawl fisheries" (OTT); "Bottom pair trawl fisheries" (PTB); "Beam trawl fisheries" (TBB); "Pots and traps" (FPO); "Stationary uncovered pound nets" (FPN); "Fyke nets" (FYK). Note that the presence of empty or single value plots is related to single year data in a particular gear group.


**Table 4.** Summary of the missing information on the days at sea reported by country and year.
```{r echo=FALSE, message=FALSE, warning = FALSE, message=FALSE, out.width="90%", out.height="90%" }
## Days at sea Total fisheries -  Annual total fishing effort by country  
# missing data (Days at Sea) (Laura's table)
Missing <- CE_years %>% 
  group_by(Year, FlagCountry , is.na(DaysAtSea)) %>% 
  summarise(missing = n()) %>% 
  filter(`is.na(DaysAtSea)` == TRUE) %>% 
  select(FlagCountry, missing)

MissingDaysAtSea <- CE_years %>% 
  group_by(Year, FlagCountry) %>%  
  summarise(Total = n()) %>% 
  full_join(Missing)

PercentageMissingDaysAtSea <- MissingDaysAtSea %>% 
  group_by(Year, FlagCountry) %>% 
  summarise('%missingRecords (DaysAtSea)' = as.integer((missing/Total)*100)) %>% 
  arrange(FlagCountry) 

# Countries with no effort data 
PercentageMissingDaysAtSea2 <- subset(PercentageMissingDaysAtSea, !is.na(`%missingRecords (DaysAtSea)`))
PercentageMissingDaysAtSea2 <- PercentageMissingDaysAtSea %>% 
  filter(!is.na(`%missingRecords (DaysAtSea)`)) %>% 
  arrange(Year)

ft<-theme_flextable(PercentageMissingDaysAtSea2)
ft

```

### Days at sea - Total fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
DAS_total <- CE_years %>%
    group_by(Year, FlagCountry) %>%
    summarise(DaysAtSea=sum(DaysAtSea))

dasTotal <- ggplot(data=DAS_total, aes(Year, round(DaysAtSea/1000,0), colour=FlagCountry)) + 
  geom_point() + geom_line() +
  theme_bw() +
  scale_colour_discrete(guide = 'none') +
  geom_dl(aes(label = FlagCountry), method = list(dl.trans(x = x + 0.1), "last.points", cex = 0.7))+
  labs(title=paste("Days at sea by country - Total fisheries -", RCG), x="year", y="Days at sea (thousands)", colour="Country") +
 theme(axis.text = element_text(size=9),plot.title=element_text(size=11), axis.title = element_text(size=9))

dasTotal <- dasTotal + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

ggplotly(dasTotal)

```

### Days at sea - Bottom trawl fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="95%", out.height="95%"}
DAS_country_OTB <- droplevels(DAS_country[!is.na(DAS_country$DaysAtSea) & DAS_country$gear %in% c('OTB'),])

# condition is used because running the Rmarkdown gives an error if no data exists

if (dim(DAS_country_OTB)[1]>0) {
dasCountryOTB <- ggplot(data=DAS_country_OTB, aes(Year, DaysAtSea, colour=FlagCountry)) +
  geom_point() + geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Days at sea by country - Bottom trawl fisheries -", RCG), x="year", y="Days at sea", colour="Country")+
  theme(legend.position="bottom", axis.text.x = element_text(size=8),  axis.text.y = element_text(size=8),plot.title=element_text(size=11), axis.title = element_text(size=9),
       legend.title=element_text(size=10),legend.text=element_text(size=9),panel.spacing.x = unit(1,"lines"), panel.spacing.y = unit(2,"lines")) 

dasCountryOTB <- dasCountryOTB + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

ggplotly(dasCountryOTB)
}

```

### Days at sea - Multi-rig otter trawl fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
DAS_country_OTT <- droplevels(DAS_country[!is.na(DAS_country$DaysAtSea) & DAS_country$gear %in% c('OTT'),])

if (dim(DAS_country_OTT)[1]>0) {
dasCountryOTT <- ggplot(data=DAS_country_OTT, aes(Year, DaysAtSea, colour=FlagCountry)) +
  geom_point() + geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Days at sea by country - Multi-rig otter trawl fisheries -", RCG), x="year", y="Days at sea", colour="Country")+
  theme(legend.position="bottom", axis.text.x = element_text(size=8),  axis.text.y = element_text(size=8),plot.title=element_text(size=11), axis.title = element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9),panel.spacing.x = unit(1,"lines"), panel.spacing.y = unit(2,"lines"))


dasCountryOTT <- dasCountryOTT + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)
ggplotly(dasCountryOTT)
}

```

### Days at sea - Bottom pair trawl fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="95%", out.height="95%"}
DAS_country_PTB <- droplevels(DAS_country[!is.na(DAS_country$DaysAtSea) & DAS_country$gear %in% c('PTB'),])

if (dim(DAS_country_PTB)[1]>0) {
dasCountryPTB <- ggplot(data=DAS_country_PTB, aes(Year, DaysAtSea, colour=FlagCountry)) +
  geom_point() + geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Days at sea by country - Bottom pair trawl fisheries -", RCG), x="year", y="Days at sea", colour="Country")+
 theme(legend.position="bottom",  axis.text.x = element_text(size=8),  axis.text.y = element_text(size=8),plot.title=element_text(size=11), axis.title = element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9),panel.spacing.x = unit(1,"lines"), panel.spacing.y = unit(2,"lines")) 

dasCountryPTB <- dasCountryPTB + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

ggplotly(dasCountryPTB)
}

```

### Days at sea - Beam trawl fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
DAS_country_TBB <- droplevels(DAS_country[!is.na(DAS_country$DaysAtSea) & DAS_country$gear %in% c('TBB'),])

if (dim(DAS_country_TBB)[1]>0) {  
dasCountryTBB <- ggplot(data=DAS_country_TBB, aes(Year, DaysAtSea, colour=FlagCountry)) +
  geom_point() + geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Days at sea by country - Beam trawl fisheries -", RCG), x="year", y="Days at sea", colour="Country")+
 theme(legend.position="bottom", axis.text.x = element_text(size=8),  axis.text.y = element_text(size=8),plot.title=element_text(size=11), axis.title = element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9),panel.spacing.x = unit(1,"lines"), panel.spacing.y = unit(2,"lines")) 


dasCountryTBB <- dasCountryTBB + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

ggplotly(dasCountryTBB)
}

```

### Days at sea - Pelagic trawl fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="95%", out.height="95%"}
DAS_country_OTM <- droplevels(DAS_country[!is.na(DAS_country$DaysAtSea) & DAS_country$gear %in% c('OTM','PTM'),])
  
if (dim(DAS_country_OTM)[1]>0) {
dasCountryOTM <- ggplot(data=DAS_country_OTM, aes(Year, DaysAtSea, colour=FlagCountry)) +
  geom_point() + geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Days at sea by country - Pelagic trawl fisheries -", RCG), x="year", y="Days at sea", colour="Country")+
 theme(legend.position="bottom", axis.text.x = element_text(size=8),  axis.text.y = element_text(size=8),plot.title=element_text(size=11), axis.title = element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9),panel.spacing.x = unit(1,"lines"), panel.spacing.y = unit(2,"lines")) 

dasCountryOTM <- dasCountryOTM + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

ggplotly(dasCountryOTM)
}

```

### Days at sea - Surrounding nets fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
DAS_country_SNet <- DAS_country[!is.na(DAS_country$DaysAtSea) & DAS_country$gear %in% c('LA_','PS_') ,]

if (dim(DAS_country_SNet)[1]>0) {
dasCountrySNet <-ggplot(data=DAS_country_SNet, aes(Year, DaysAtSea, colour=FlagCountry)) +
  geom_point() + geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Days at sea by country - Surrounding nets fisheries -", RCG), x="year", y="Days at sea", colour="Country")+
 theme(legend.position="bottom",  axis.text.x = element_text(size=8),  axis.text.y = element_text(size=8),plot.title=element_text(size=11), axis.title = element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9),panel.spacing.x = unit(1,"lines"), panel.spacing.y = unit(2,"lines")) 

dasCountrySNet <- dasCountrySNet + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

ggplotly(dasCountrySNet)
}

```

### Days at sea - Seine fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="95%", out.height="95%"}
DAS_country_S <- droplevels(DAS_country[!is.na(DAS_country$DaysAtSea) & DAS_country$gear %in% c('SB_','SV_','SSC','SDN','SPR') ,])

if (dim(DAS_country_S)[1]>0) {
dasCountryS <- ggplot(data=DAS_country_S, aes(Year, DaysAtSea, colour=FlagCountry)) +
  geom_point() + geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Days at sea by country - Seine fisheries -", RCG), x="year", y="Days at sea", colour="Country")+
 theme(legend.position="bottom", axis.text.x = element_text(size=8),  axis.text.y = element_text(size=8),plot.title=element_text(size=11), axis.title = element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9),panel.spacing.x = unit(1,"lines"), panel.spacing.y = unit(2,"lines")) 

dasCountryS <- dasCountryS + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

ggplotly(dasCountryS)
}

```

### Days at sea - Net fisheries

```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="95%", out.height="95%"}
DAS_country_N <- droplevels(DAS_country[!is.na(DAS_country$DaysAtSea) & DAS_country$gear %in% c('GNS','GND','GTR'),])

if (dim(DAS_country_N)[1]>0) {
dasCountryN <- ggplot(data=DAS_country_N, aes(Year, DaysAtSea, colour=FlagCountry)) +
  geom_point() + geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Days at sea by country - Net fisheries -", RCG), x="year", y="Days at sea", colour="Country")+
 theme(legend.position="bottom", axis.text.x = element_text(size=8),  axis.text.y = element_text(size=8),plot.title=element_text(size=11), axis.title = element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9),panel.spacing.x = unit(1,"lines"), panel.spacing.y = unit(2,"lines"))

dasCountryN <- dasCountryN + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

ggplotly(dasCountryN)
}

```

### Days at sea - Longline fisheries

```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="95%", out.height="95%"}
DAS_country_LL <- droplevels(DAS_country[!is.na(DAS_country$DaysAtSea) & DAS_country$gear %in% c('LLS','LLD'),])

if (dim(DAS_country_LL)[1]>0) {
dasCountryLL <- ggplot(data=DAS_country_LL, aes(Year, DaysAtSea, colour=FlagCountry)) +
  geom_point() + geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Days at sea by country - Longline fisheries -", RCG), x="year", y="Days at sea", colour="Country")+
 theme(legend.position="bottom", axis.text.x = element_text(size=8),  axis.text.y = element_text(size=8),plot.title=element_text(size=11), axis.title = element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9),panel.spacing.x = unit(1,"lines"), panel.spacing.y = unit(2,"lines")) 

dasCountryLL <- dasCountryLL + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

ggplotly(dasCountryLL)
}

```

### Days at sea - Rods and lines fisheries

```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="95%", out.height="95%"}
DAS_country_RL <- droplevels(DAS_country[!is.na(DAS_country$DaysAtSea) & DAS_country$gear %in% c("LHP",'LHM','LTL'),])

if (dim(DAS_country_RL)[1]>0) {
dasCountryRL <- ggplot(data=DAS_country_RL, aes(Year, DaysAtSea, colour=FlagCountry)) +
  geom_point() + geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Days at sea by country - Rods and lines fisheries -", RCG), x="year", y="Days at sea", colour="Country")+
 theme(legend.position="bottom", axis.text.x = element_text(size=8),  axis.text.y = element_text(size=8),plot.title=element_text(size=11), axis.title = element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9),panel.spacing.x = unit(1,"lines"), panel.spacing.y = unit(2,"lines")) 

dasCountryRL <- dasCountryRL + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

ggplotly(dasCountryRL)
}

```

### Days at sea - Dredge fisheries

```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
DAS_country_D <- droplevels(DAS_country[!is.na(DAS_country$DaysAtSea) & DAS_country$gear %in% c("DRB","HMD"),])

if (dim(DAS_country_D)[1]>0) {
dasCountryD <- ggplot(data=DAS_country_D, aes(Year, DaysAtSea, colour=FlagCountry)) +
  geom_point() + geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Days at sea by country - Dredge fisheries -", RCG), x="year", y="Days at sea", colour="Country")+
 theme(legend.position="bottom", axis.text.x = element_text(size=8),  axis.text.y = element_text(size=8),plot.title=element_text(size=11), axis.title = element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9),panel.spacing.x = unit(1,"lines"), panel.spacing.y = unit(2,"lines")) 

dasCountryD <- dasCountryD + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

ggplotly(dasCountryD)
}

```

### Days at sea - Pots and traps fisheries

```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="95%", out.height="95%"}
DAS_country_FPO <- droplevels(DAS_country[!is.na(DAS_country$DaysAtSea) & DAS_country$gear %in% c("FPO"),])

if (dim(DAS_country_FPO)[1]>0) {
dasCountryFPO <- ggplot(data=DAS_country_FPO, aes(Year, DaysAtSea, colour=FlagCountry)) +
  geom_point() + geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Days at sea by country - Pots and traps fisheries -", RCG), x="year", y="Days at sea", colour="Country")+
 theme(legend.position="bottom", axis.text.x = element_text(size=8),  axis.text.y = element_text(size=8),plot.title=element_text(size=11), axis.title = element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9),panel.spacing.x = unit(1,"lines"), panel.spacing.y = unit(2,"lines")) 

dasCountryFPO <- dasCountryFPO + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

ggplotly(dasCountryFPO)
}

```
### Days at sea - Stationary uncovered pound nets fisheries

```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="95%", out.height="95%"}
DAS_country_FPN <- droplevels(DAS_country[!is.na(DAS_country$DaysAtSea) & DAS_country$gear %in% c("FPN"),])

if (dim(DAS_country_FPN)[1]>0) {
dasCountryFPN <- ggplot(data=DAS_country_FPN, aes(Year, DaysAtSea, colour=FlagCountry)) +
  geom_point() + geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Days at sea by country - Stationary uncovered pound nets fisheries -", RCG), x="year", y="Days at sea", colour="Country")+
 theme(legend.position="bottom", axis.text.x = element_text(size=8),  axis.text.y = element_text(size=8),plot.title=element_text(size=11), axis.title = element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9),panel.spacing.x = unit(1,"lines"), panel.spacing.y = unit(2,"lines")) 

dasCountryFPN <- dasCountryFPN + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

ggplotly(dasCountryFPN)
}

```

### Days at sea - Fyke nets (FYK)

```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="95%", out.height="95%"}
DAS_country_FYK <- droplevels(DAS_country[!is.na(DAS_country$DaysAtSea) & DAS_country$gear %in% c("FYK"),])

if (dim(DAS_country_FYK)[1]>0) {
dasCountryFYK <- ggplot(data=DAS_country_FYK, aes(Year, DaysAtSea, colour=FlagCountry)) +
  geom_point() + geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Days at sea by country - Fyke nets -", RCG), x="year", y="Days at sea", colour="Country")+
 theme(legend.position="bottom", axis.text.x = element_text(size=8),  axis.text.y = element_text(size=8),plot.title=element_text(size=11), axis.title = element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9),panel.spacing.x = unit(1,"lines"), panel.spacing.y = unit(2,"lines")) 

dasCountryFYK <- dasCountryFYK + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

ggplotly(dasCountryFYK)
}

```

## {-}

## Landings {.tabset}

The annual landings overview for the `r title_stock`, is presented in the interactive figures below. The first panel ('Landings Total fisheries') compiles the annual total landings by flag country. The following panels present the annual total landings from the different fisheries by flag country, where the "Fishing activity level 5" data is grouped according to métier level 3 definition: the "Pelagic trawl fisheries" include the mid-water otter trawl (OTM) and pelagic pair trawl (PTM); the "Surrounding nets fisheries" include the lampara nets (LA) and purse seine (PS); the "Seine fisheries" include the beach and boat seines (SB and SV), the fly shooting seine (SSC), anchored seine (SDN) and pair seine (SPR); the "Net fisheries" include set gillnet (GNS), driftnet (GND) and trammel net (GTR); the "Longline fisheries" include set and drifting longlines (LLS and LLD); the "Rods and lines fisheries" include the hand and pole lines (LHP and LHM) and the trolling lines (LTL); the "Dredge fisheries" include boat and hand dredges (DRB and HMD). In the case of the bottom trawls and traps, the panels are presented by metier level 4 due to the higher number of metiers level 5 present in these groups: "Bottom otter trawl fisheries" (OTB); "Multi-rig otter trawl fisheries" (OTT); "Bottom pair trawl fisheries" (PTB); "Beam trawl fisheries" (TBB); "Pots and traps" (FPO); "Stationary uncovered pound nets" (FPN); "Fyke nets" (FYK). Note that the presence of empty or single value plots is related to single year data in a particular gear group.

### Landings - Total fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}

Landings_total <- CL_years %>%
  group_by(Year, FlagCountry) %>%
  summarise(LandingWeight_ton=sum(LandingWeight_ton))

landingsTotal <- ggplot(data=Landings_total, aes(Year, round(LandingWeight_ton/1000,0), colour=FlagCountry)) +
  geom_point() + geom_line() +
  scale_colour_discrete(guide = 'none') +
  geom_dl(aes(label = FlagCountry), method = list(dl.trans(x = x + 0.1), "last.points", cex = 0.7))+
  labs(title=paste("Landings by country - Total fisheries -", RCG), x="year", y="Landings (thousand ton)")+
  theme(axis.text.x = element_text(size=9), plot.title=element_text(size=11), axis.title = element_text(size=9))+
  theme_bw()

landingsTotal <- landingsTotal + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

ggplotly(landingsTotal)

```

### Landings - Bottom trawl fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="95%", out.height="95%"}
Landings_country_OTB <- droplevels(Landings_country[!is.na(Landings_country$LandingWeight_ton) & Landings_country$gear %in% c('OTB'),])

if (dim(Landings_country_OTB)[1]>0) {
landingsOTB <- ggplot(data=Landings_country_OTB, aes(Year, LandingWeight_ton, colour=FlagCountry)) +
  geom_point() + geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Landings by country Bottom trawl fisheries -", RCG), x="year", y="Landings (ton)", colour="Country")+
 theme(legend.position="bottom", axis.text.x = element_text(size=8),  axis.text.y = element_text(size=8),plot.title=element_text(size=11), axis.title = element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9),panel.spacing.x = unit(2,"lines"), panel.spacing.y = unit(2,"lines")) 

landingsOTB <- landingsOTB + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

ggplotly(landingsOTB)
}

```

### Landings - Multi-rig otter trawl fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
Landings_country_OTT <- droplevels(Landings_country[!is.na(Landings_country$LandingWeight_ton) & Landings_country$gear %in% c('OTT'),])

if (dim(Landings_country_OTT)[1]>0) {
landingsOTT <- ggplot(data=Landings_country_OTT, aes(Year, LandingWeight_ton, colour=FlagCountry)) +
  geom_point() + geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Landings by country - Multi-rig otter trawl fisheries -", RCG), x="year", y="Landings (ton)", colour="Country")+
 theme(legend.position="bottom", axis.text.x = element_text(size=8),  axis.text.y = element_text(size=8),plot.title=element_text(size=11), axis.title = element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9),panel.spacing.x = unit(2,"lines"), panel.spacing.y = unit(2,"lines")) 

landingsOTT <- landingsOTT + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

ggplotly(landingsOTT)
}

```

### Landings - Bottom pair trawl fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="95%", out.height="95%"}
Landings_country_PTB <- droplevels(Landings_country[!is.na(Landings_country$LandingWeight_ton) & Landings_country$gear %in% c('PTB'),])

if (dim(Landings_country_PTB)[1]>0) {
landingsPTB <- ggplot(data=Landings_country_PTB, aes(Year, LandingWeight_ton, colour=FlagCountry)) +
  geom_point() + geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Landings by country - Bottom pair trawl fisheries -", RCG), x="year", y="Landings (ton)", colour="Country")+
 theme(legend.position="bottom",  axis.text.x = element_text(size=8),  axis.text.y = element_text(size=8),plot.title=element_text(size=11), axis.title = element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9),panel.spacing.x = unit(2,"lines"), panel.spacing.y = unit(2,"lines")) 

landingsPTB <- landingsPTB + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

ggplotly(landingsPTB)
}

```

### Landings - Beam trawl fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
Landings_country_TBB <- droplevels(Landings_country[!is.na(Landings_country$LandingWeight_ton) & Landings_country$gear %in% c('TBB'),])

if (dim(Landings_country_TBB)[1]>0) {

landingsTBB <-ggplot(data=Landings_country_TBB, aes(Year, LandingWeight_ton, colour=FlagCountry)) +
  geom_point() + geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Landings by country - Beam trawl fisheries -", RCG), x="year", y="Landings (ton)", colour="Country")+
 theme(legend.position="bottom", axis.text.x = element_text(size=8),  axis.text.y = element_text(size=8),plot.title=element_text(size=11), axis.title = element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9),panel.spacing.x = unit(2,"lines"), panel.spacing.y = unit(2,"lines")) 

landingsTBB <- landingsTBB + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

ggplotly(landingsTBB)
}

```

### Landings - Pelagic trawl fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="95%", out.height="95%"}
Landings_country_OTM <- droplevels(Landings_country[!is.na(Landings_country$LandingWeight_ton) & Landings_country$gear %in% c("OTM","PTM"),])

if (dim(Landings_country_OTM)[1]>0) {
landingsOTM <- ggplot(data=Landings_country_OTM, aes(Year, LandingWeight_ton, colour=FlagCountry)) +
  geom_point() + geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Landings by country - Pelagic trawl fisheries -", RCG), x="year", y="Landings (ton)", colour="Country")+
 theme(legend.position="bottom", axis.text.x = element_text(size=8),  axis.text.y = element_text(size=8),plot.title=element_text(size=11), axis.title = element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9),panel.spacing.x = unit(2,"lines"), panel.spacing.y = unit(2,"lines")) 

landingsOTM <- landingsOTM + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

ggplotly(landingsOTM)
}

```

### Landings - Surrounding nets fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
Landings_country_SNet <- droplevels(Landings_country[!is.na(Landings_country$LandingWeight_ton) & Landings_country$gear %in% c("LA_","PS_"),])

if (dim(Landings_country_SNet)[1]>0) {
landingsSNet <- ggplot(data=Landings_country_SNet, aes(Year, LandingWeight_ton, colour=FlagCountry)) +
  geom_point() + geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Landings by country - Surrounding net fisheries -", RCG), x="year", y="Landings (ton)", colour="Country")+
 theme(legend.position="bottom",  axis.text.x = element_text(size=8),  axis.text.y = element_text(size=8),plot.title=element_text(size=11), axis.title = element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9),panel.spacing.x = unit(2,"lines"), panel.spacing.y = unit(2,"lines")) 

landingsSNet <- landingsSNet + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

ggplotly(landingsSNet)
}

```

### Landings - Seine fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="95%", out.height="95%"}
Landings_country_S <- Landings_country[Landings_country$gear %in% c("SDN","SSC","SB_"),]

if (dim(Landings_country_S)[1]>0) {
landingsS <- ggplot(data=Landings_country_S, aes(Year, LandingWeight_ton, colour=FlagCountry)) +
  geom_point() +geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Landings by country - Seine fisheries -", RCG), x="year", y="Landings (ton)", colour="Country")+
 theme(legend.position="bottom",  axis.text.x = element_text(size=8),  axis.text.y = element_text(size=8),plot.title=element_text(size=11), axis.title = element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9),panel.spacing.x = unit(2,"lines"), panel.spacing.y = unit(2,"lines")) 

landingsS <- landingsS + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

ggplotly(landingsS)
}

```

### Landings - Net fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="95%", out.height="95%"}
Landings_country_N <- droplevels(Landings_country[!is.na(Landings_country$LandingWeight_ton) & Landings_country$gear %in% c('GNS','GND','GTR'),])

if (dim(Landings_country_N)[1]>0) {
landingsN <- ggplot(data=Landings_country_N, aes(Year, LandingWeight_ton, colour=FlagCountry)) +
  geom_point() +geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Landings by country - Net fisheries -", RCG), x="year", y="Landings (ton)", colour="Country")+
 theme(legend.position="bottom",  axis.text.x = element_text(size=8),  axis.text.y = element_text(size=8),plot.title=element_text(size=11), axis.title = element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9),panel.spacing.x = unit(1,"lines"), panel.spacing.y = unit(2,"lines")) 

landingsN <- landingsN + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

ggplotly(landingsN)
}

```

### Landings - Longline fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="95%", out.height="95%"}
Landings_country_LL <- droplevels(Landings_country[!is.na(Landings_country$LandingWeight_ton) & Landings_country$gear %in% c('LLS','LLD'),])

if (dim(Landings_country_LL)[1]>0) {
landingsLL <- ggplot(data=Landings_country_LL, aes(Year, LandingWeight_ton, colour=FlagCountry)) +
  geom_point() +geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Landings by country - Longline fisheries -", RCG), x="year", y="Landings (ton)", colour="Country")+
 theme(legend.position="bottom", axis.text.x = element_text(size=8),  axis.text.y = element_text(size=8),plot.title=element_text(size=11), axis.title = element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9),panel.spacing.x = unit(2,"lines"), panel.spacing.y = unit(2,"lines")) 

landingsLL <- landingsLL + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

ggplotly(landingsLL)
}

```

### Landings - Rods and lines fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="95%", out.height="95%"}
Landings_country_RL <- droplevels(Landings_country[!is.na(Landings_country$LandingWeight_ton) & Landings_country$gear %in% c('LHP','LHM','LTL'),])

if (dim(Landings_country_RL)[1]>0) {
landingsRL <- ggplot(data=Landings_country_RL, aes(Year, LandingWeight_ton, colour=FlagCountry)) +
  geom_point() +geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Landings by country - Rods and lines fisheries -", RCG), x="year", y="Landings (ton)", colour="Country")+
 theme(legend.position="bottom", axis.text.x = element_text(size=8),  axis.text.y = element_text(size=8),plot.title=element_text(size=11), axis.title = element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9),panel.spacing.x = unit(2,"lines"), panel.spacing.y = unit(2,"lines")) 

landingsRL <- landingsRL + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

ggplotly(landingsRL)
}

```

### Landings - Dredge fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}
Landings_country_D <- droplevels(Landings_country[!is.na(Landings_country$LandingWeight_ton) & Landings_country$gear %in% c("DRB","HMD"),])

if (dim(Landings_country_D)[1]>0) {
landingsD <- ggplot(data=Landings_country_D, aes(Year, LandingWeight_ton, colour=FlagCountry)) +
  geom_point() +geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Landings by country - Dredge fisheries -", RCG), x="year", y="Landings (ton)", colour="Country")+
 theme(legend.position="bottom", axis.text.x = element_text(size=8),  axis.text.y = element_text(size=8),plot.title=element_text(size=11), axis.title = element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9),panel.spacing.x = unit(2,"lines"), panel.spacing.y = unit(2,"lines")) 

landingsD <- landingsD + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

ggplotly(landingsD)
}

```

### Landings - Pots and traps fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="95%", out.height="95%"}
Landings_country_FPO <- droplevels(Landings_country[!is.na(Landings_country$LandingWeight_ton) & Landings_country$gear %in% c('FPO'),])

if (dim(Landings_country_FPO)[1]>0) {
landingsFPO <- ggplot(data=Landings_country_FPO, aes(Year, LandingWeight_ton, colour=FlagCountry)) +
  geom_point() +geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Landings by country - Pots and traps fisheries -", RCG), x="year", y="Landings (ton)", colour="Country")+
 theme(legend.position="bottom",  axis.text.x = element_text(size=8),  axis.text.y = element_text(size=8),plot.title=element_text(size=11), axis.title = element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9),panel.spacing.x = unit(2,"lines"), panel.spacing.y = unit(2,"lines"))

landingsFPO <- landingsFPO + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

ggplotly(landingsFPO)
}

```

### Landings - Stationary uncovered pound nets fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="95%", out.height="95%"}
Landings_country_FPN <- droplevels(Landings_country[!is.na(Landings_country$LandingWeight_ton) & Landings_country$gear %in% c('FPN'),])

if (dim(DAS_country_FPN)[1]>0) {
landingsFPN <- ggplot(data=Landings_country_FPN, aes(Year, LandingWeight_ton, colour=FlagCountry)) +
  geom_point() +geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Landings by country - Stationary uncovered pound nets fisheries -", RCG), x="year", y="Landings (ton)", colour="Country")+
 theme(legend.position="bottom",  axis.text.x = element_text(size=8),  axis.text.y = element_text(size=8),plot.title=element_text(size=11), axis.title = element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9),panel.spacing.x = unit(2,"lines"), panel.spacing.y = unit(2,"lines"))

landingsFPN <- landingsFPN + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

ggplotly(landingsFPN)
}

```

### Landings - Fyke nets fisheries
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="95%", out.height="95%"}
Landings_country_FYK <- droplevels(Landings_country[!is.na(Landings_country$LandingWeight_ton) & Landings_country$gear %in% c('FYK'),])

if (dim(Landings_country_FYK)[1]>0) {
landingsFYK <- ggplot(data=Landings_country_FYK, aes(Year, LandingWeight_ton, colour=FlagCountry)) +
  geom_point() +geom_line() +
  theme_bw() +
  facet_wrap(~FishingActivityLvl5, scales="free_y")+
  labs(title=paste("Landings by country - Fyke nets fisheries -", RCG), x="year", y="Landings (ton)", colour="Country")+
 theme(legend.position="bottom",  axis.text.x = element_text(size=8),  axis.text.y = element_text(size=8),plot.title=element_text(size=11), axis.title = element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9),panel.spacing.x = unit(2,"lines"), panel.spacing.y = unit(2,"lines"))

landingsFYK <- landingsFYK + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

ggplotly(landingsFYK)
}

```
## {-}

### Foreign Landings

The table below presents summary information on total landings abroad reported by year, country and area, for the period `r years[1]` - `r years[6]`. The data summarized includes the weight (in tons) of the foreign landings and its percentage in relation to the national total landing weight per area.

```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}

totLandFlagC <- CL_years %>% group_by(Year, FlagCountry,Area) %>% summarise(LandWeighTon=sum(OfficialLandingCatchWeight_ton)) %>% data.frame

CL_years$FlagCountry <- as.character(CL_years$FlagCountry); CL_years$LandingCountry <- as.character(CL_years$LandingCountry)

foreignLand <- CL_years[!CL_years$FlagCountry==CL_years$LandingCountry,]

foreignLandSum <- foreignLand %>% group_by(Year, FlagCountry, Area, LandingCountry) %>% summarise(foreignland= sum(OfficialLandingCatchWeight_ton)) %>% data.frame

foreignLandSum$totalLand <- totLandFlagC$LandWeighTon[match(paste(foreignLandSum$Year,foreignLandSum$Area,foreignLandSum$FlagCountry), paste(totLandFlagC$Year,totLandFlagC$Area,totLandFlagC$FlagCountry))]

tableForeign <- foreignLandSum %>% mutate(perc_foreignLand=round((foreignland/totalLand)*100,1))

# Rename some of the variables for the table
tableForeign <- tableForeign %>% rename(ForeignLandings=foreignland, NationalLandings=totalLand, Percentage=perc_foreignLand)

tableForeign$ForeignLandings <- round(tableForeign$ForeignLandings,1)
tableForeign$NationalLandings <- round(tableForeign$NationalLandings,1)
DT::datatable(tableForeign, filter = list(
  position = 'top', clear = FALSE
))

```

## {-}

## Landings by catch group {.tabset}

A characterization of the landings by catch group in `r title_stock` is presented. The catch groups considered for this characterization are: Small Pelagic fish (SPF); Crustaceans (CRU); Demersal fish (DEF); Molluscs (MOL); Elasmobranch fish (EF); Flatfish (FF); Large Pelagic fish (LPF); Diadromous fish (DIA). 


## Overall Summary {.tabset}

The figures below include an overall summary of the catch group composition by flag country and gear group for the period `r years[1]`-`r years[6]`.

### Total landings by catch groups and country
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="95%", out.height="95%"}
Landings_sum_country <- CL_years %>%
  group_by(Year, FlagCountry, Catch_group) %>%
  summarise(LandingWeight_ton=sum(LandingWeight_ton))

land_count <- ggplot(data=Landings_sum_country, aes(FlagCountry, LandingWeight_ton, fill=Catch_group)) +
  geom_bar(position="fill", stat="identity") +
  theme_bw() +
  facet_wrap(~Year)+
  labs(title=paste("Landings of catch group by country -", RCG), x="Country", y="Proportion of landings", fill="Catch group")+
 theme(legend.position="bottom", axis.text.x=element_text(size=8,angle=90),  axis.text.y=element_text(size=8),plot.title=element_text(size=11), axis.title=element_text(size=10),legend.title=element_text(size=9),legend.text=element_text(size=8),
       panel.spacing.y = unit(2,"lines")) #panel.spacing.x = unit(1,"lines"), 

ggplotly(land_count)

```

### Total landings by catch groups and gear
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="95%", out.height="95%"}
CL_years$Gear <- substring(CL_years$FishingActivityLvl5,1,3)
CL_years[CL_years$Gear=='PS_',]$Gear <- 'PS'
CL_years[CL_years$Gear=='SB_',]$Gear <- 'SB'

Landings_sum_gear <- CL_years %>%
  group_by(Year, Gear, Catch_group) %>%
  summarise(LandingWeight_ton=sum(LandingWeight_ton))

land_gear <- ggplot(data=Landings_sum_gear, aes(Gear, LandingWeight_ton, fill=Catch_group)) +
  geom_bar(position="fill", stat="identity") +
  theme_bw() +
  facet_wrap(~Year)+
  labs(title=paste("Landings of catch group by gear -", RCG), x="Gear", y="Proportion of landings", fill="Catch group")+
theme(legend.position="bottom",axis.text.x=element_text(size=7,angle=90),  axis.text.y=element_text(size=8),plot.title=element_text(size=11), axis.title=element_text(size=10),legend.title=element_text(size=9),legend.text=element_text(size=8),
       panel.spacing.y = unit(2,"lines")) #panel.spacing.x = unit(1,"lines"), 

ggplotly(land_gear)

```
## Information by catch group {.tabset}

The following panels present the summary information for each of the catch group landings composition by flag country, fishing gear group and vessel length. 

### Total landings of Small Pelagic Fish (SPF)
```{r echo=FALSE, message=FALSE, warning = FALSE, , out.width="90%", out.height="90%", fig.height = 8, fig.width = 10}

CL_years_spf <- droplevels(CL_years[CL_years$Catch_group=='small pelagic',])
Landings_spf <- CL_years_spf %>%
  group_by(Year, FlagCountry) %>%
  summarise(LandingWeight_ton=sum(LandingWeight_ton))

p1 <- ggplot(data=Landings_spf, aes(Year, round(LandingWeight_ton/1000,0), colour=FlagCountry)) +
  geom_point() + geom_line(size=1)  +
  theme_bw() +
  scale_colour_discrete(guide = 'none') +
  #geom_dl(aes(label = FlagCountry), method = list(dl.trans(x = x + 0.2), "last.points", cex = 0.7))+
  labs(title=paste("Landings of SPF by country -", RCG), x="year", y="Landings (thousand ton)") +
  theme(axis.text = element_text(size=9), plot.title=element_text(size=11), axis.title = element_text(size=9),legend.position = "none")

p1 <- p1 + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)



# Landings by Flag Country

CL_years_spf$FlagCountry1 <- as.character(CL_years_spf$FlagCountry)
spf_countries_top10 <- CL_years_spf %>%
  group_by(FlagCountry1) %>%
  summarise(lwTot=sum(LandingWeight_ton)) %>%
  arrange(desc(lwTot)) %>%  
  top_n(10) %>% data.frame

spf_countries_top10$Top10countries <- "X"
landings_spf <- left_join(CL_years_spf,spf_countries_top10,by="FlagCountry1")
landings_spf$topCountries <- ifelse(is.na(landings_spf$Top10countries),"Other countries",landings_spf$FlagCountry1)

landings_spf_sum <- landings_spf %>%
  group_by(Year, topCountries) %>%
  summarise(Landing_ton=sum(LandingWeight_ton)) %>% arrange(topCountries)

p2 <- ggplot(data=landings_spf_sum, aes(x=Year, y=Landing_ton, fill=topCountries)) +
  geom_bar(position="fill", stat="identity") +
  theme_bw() +
  labs(title=paste("Landings of SPF by top 10 countries -", RCG), x="year", y="Proportion of landings", fill="Country") +
  theme(axis.text = element_text(size=8), plot.title=element_text(size=11), axis.title=element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9)) 

p2 <- p2 + scale_fill_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)


# Landings by gear group (FishingActivityLvl5)

CL_years_spf$FishingActivityLvl5_1 <- as.character(CL_years_spf$FishingActivityLvl5)
spf_gear_top10 <- CL_years_spf %>%
  group_by(FishingActivityLvl5_1) %>%
  summarise(lwTot=sum(LandingWeight_ton)) %>%
  arrange(desc(lwTot)) %>%  
  top_n(10) %>% data.frame

spf_gear_top10$Top10gear <- "X"
landings_spf <- left_join(CL_years_spf,spf_gear_top10,by="FishingActivityLvl5_1")
landings_spf$topGears <- ifelse(is.na(landings_spf$Top10gear),"Other gears",landings_spf$FishingActivityLvl5_1)

landings_spf_sum <- landings_spf %>%
  group_by(Year, topGears) %>%
  summarise(Landing_ton=sum(LandingWeight_ton)) %>% arrange(topGears)

p3 <- ggplot(data=landings_spf_sum, aes(x=Year, y=Landing_ton, fill=topGears)) +
  geom_bar(position="fill", stat="identity") +
  theme_bw() +
  labs(title=paste("Landings of SPF by top 10 gears -", RCG), x="year", y="Proportion of landings", fill="Métier Level 5") +
  theme(axis.text = element_text(size=8), plot.title=element_text(size=11), axis.title=element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9))

# landings by vessel_length

CL_years_spf$Loa1 <- as.factor(CL_years_spf$VesselLengthCategory)
CL_years_spf <- droplevels(CL_years_spf[!is.na(CL_years_spf$Loa1),])
spf_Loa <- CL_years_spf %>%
  group_by(Loa1) %>%
  summarise(lwTot=sum(LandingWeight_ton)) %>%
  arrange(desc(lwTot)) %>%  
  data.frame

landings_spf_Loa_sum <- CL_years_spf %>%
  group_by(Year, Loa1) %>%
  summarise(Landing_ton=sum(LandingWeight_ton)) 

p4 <- landings_spf_Loa_sum %>% 
  mutate(Loa1 = factor(Loa1, levels=c('<10','10-<12','12-<18','18-<24','24-<40','>40'))) %>%
  ggplot(aes(x=Year, y=Landing_ton, fill=Loa1)) +
  geom_bar(position="fill", stat="identity") +
  theme_bw() +
  labs(title=paste("Landings of SPF by vessel length -", RCG), x="year", y="Proportion of landings", fill="Vessel Length\n(m)") +
   theme(axis.text = element_text(size=8), plot.title=element_text(size=11), axis.title=element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9)) 

## Two options for the output

# Option 1: simple plots in a grid (2x2)

grid.arrange(p1,p2,p3,p4)

# Option 2: interactive plots as a list (1x4)

#p1a <- ggplotly(p1)
#p2a <- ggplotly(p2)
#p3a <- ggplotly(p3)
#p4a <- ggplotly(p4)
#p <- grid.arrange(p1a, p2a, p3a, p4a)
#htmltools::tagList(list(p))


```


### Total landings of Crustaceans (CRU)
```{r echo=FALSE, message=FALSE, warning = FALSE,, out.width="90%", out.height="90%", fig.height = 8, fig.width = 10}
CL_years_cru <- droplevels(CL_years[CL_years$Catch_group=='crustaceans',])
Landings_cru <- CL_years_cru %>%
  group_by(Year, FlagCountry) %>%
  summarise(LandingWeight_ton=sum(LandingWeight_ton))

p1 <- ggplot(data=Landings_cru, aes(Year, round(LandingWeight_ton,0), colour=FlagCountry)) +
  geom_point() + geom_line(size=1) +
  theme_bw() +
  scale_colour_discrete(guide = 'none') +
  #geom_dl(aes(label = FlagCountry), method = list(dl.trans(x = x + 0.1), "last.points", cex = 0.7))+
  labs(title=paste("Landings of CRU by country -", RCG), x="year", y="Landings (ton)") +
  theme(axis.text = element_text(size=9), plot.title=element_text(size=11), axis.title = element_text(size=9),legend.position = "none") 

p1 <- p1 + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)


# Landings by Flag Country

CL_years_cru$FlagCountry1 <- as.character(CL_years_cru$FlagCountry)
cru_countries_top10 <- CL_years_cru %>%
  group_by(FlagCountry1) %>%
  summarise(lwTot=sum(LandingWeight_ton)) %>%
  arrange(desc(lwTot)) %>%  
  top_n(10) %>% data.frame

cru_countries_top10$Top10countries <- "X"
landings_cru <- left_join(CL_years_cru,cru_countries_top10,by="FlagCountry1")
landings_cru$topCountries <- ifelse(is.na(landings_cru$Top10countries),"Other countries",landings_cru$FlagCountry1)

landings_cru_sum <- landings_cru %>%
  group_by(Year, topCountries) %>%
  summarise(Landing_ton=sum(LandingWeight_ton)) %>% arrange(topCountries)

p2 <- ggplot(data=landings_cru_sum, aes(x=Year, y=Landing_ton, fill=topCountries)) +
  geom_bar(position="fill", stat="identity") +
 theme_bw() +
  labs(title=paste("Landings of CRU by top 10 countries -", RCG), x="year", y="Proportion of landings", fill="Country") +
   theme(axis.text = element_text(size=8), plot.title=element_text(size=11), axis.title=element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9)) 

p2 <- p2 + scale_fill_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

# Landings by gear group (FishingActivityLvl5)

CL_years_cru$FishingActivityLvl5_1 <- as.character(CL_years_cru$FishingActivityLvl5)
cru_gear_top10 <- CL_years_cru %>%
  group_by(FishingActivityLvl5_1) %>%
  summarise(lwTot=sum(LandingWeight_ton)) %>%
  arrange(desc(lwTot)) %>%  
  top_n(10) %>% data.frame

cru_gear_top10$Top10gear <- "X"
landings_cru <- left_join(CL_years_cru,cru_gear_top10,by="FishingActivityLvl5_1")
landings_cru$topGears <- ifelse(is.na(landings_cru$Top10gear),"Other gears",landings_cru$FishingActivityLvl5_1)

landings_cru_sum <- landings_cru %>%
  group_by(Year, topGears) %>%
  summarise(Landing_ton=sum(LandingWeight_ton)) %>% arrange(topGears)

p3 <- ggplot(data=landings_cru_sum, aes(x=Year, y=Landing_ton, fill=topGears)) +
  geom_bar(position="fill", stat="identity") + 
  theme_bw() +
  labs(title=paste("Landings of CRU by top 10 gears -", RCG), x="year", y="Proportion of landings", fill="Métier Level 5") +
   theme(axis.text = element_text(size=8), plot.title=element_text(size=11), axis.title=element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9)) 


# landings by vessel_length

CL_years_cru$Loa1 <- as.factor(CL_years_cru$VesselLengthCategory)
CL_years_cru <- droplevels(CL_years_cru[!is.na(CL_years_cru$Loa1),])
cru_Loa <- CL_years_cru %>%
  group_by(Loa1) %>%
  summarise(lwTot=sum(LandingWeight_ton)) %>%
  arrange(desc(lwTot)) %>%  
  data.frame

landings_cru_Loa_sum <- CL_years_cru %>%
  group_by(Year, Loa1) %>%
  summarise(Landing_ton=sum(LandingWeight_ton)) 


p4 <- landings_cru_Loa_sum %>% 
  mutate(Loa1 = factor(Loa1, levels=c('<10','10-<12','12-<18','18-<24','24-<40','>40'))) %>%
  ggplot(aes(x=Year, y=Landing_ton, fill=Loa1)) +
  geom_bar(position="fill", stat="identity") +
  theme_bw() +
  labs(title=paste("Landings of CRU by vessel length -", RCG), x="year", y="Proportion of landings", fill="Vessel Length\n(m)") +
  theme(axis.text = element_text(size=8), plot.title=element_text(size=11), axis.title=element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9)) 

grid.arrange(p1,p2,p3,p4)


```


### Total landings of Demersal fish (DEF)

```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%", fig.height = 8, fig.width = 10}
CL_years_def <- droplevels(CL_years[CL_years$Catch_group=='demersal',])
Landings_def <- CL_years_def %>%
  group_by(Year, FlagCountry) %>%
  summarise(LandingWeight_ton=sum(LandingWeight_ton))

p1 <- ggplot(data=Landings_def, aes(Year, round(LandingWeight_ton/1000,0), colour=FlagCountry)) +
  geom_point() + geom_line(size=1) +
  theme_bw() +
  scale_colour_discrete(guide = 'none') +
 # geom_dl(aes(label = FlagCountry), method = list(dl.trans(x = x + 0.1), "last.points", cex = 0.7))+
  labs(title=paste("Landings of DEF by country -", RCG), x="year", y="Landings (thousand ton)") +
  theme(axis.text = element_text(size=9), plot.title=element_text(size=11), axis.title = element_text(size=9),legend.position = "none") 

p1 <- p1 + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)


# Landings by Flag Country

CL_years_def$FlagCountry1 <- as.character(CL_years_def$FlagCountry)
def_countries_top10 <- CL_years_def %>%
  group_by(FlagCountry1) %>%
  summarise(lwTot=sum(LandingWeight_ton)) %>%
  arrange(desc(lwTot)) %>%  
  top_n(10) %>% data.frame

def_countries_top10$Top10countries <- "X"
landings_def <- left_join(CL_years_def,def_countries_top10,by="FlagCountry1")
landings_def$topCountries <- ifelse(is.na(landings_def$Top10countries),"Other countries",landings_def$FlagCountry1)

landings_def_sum <- landings_def %>%
  group_by(Year, topCountries) %>%
  summarise(Landing_ton=sum(LandingWeight_ton)) %>% arrange(topCountries)

p2 <- ggplot(data=landings_def_sum, aes(x=Year, y=Landing_ton, fill=topCountries)) +
  geom_bar(position="fill", stat="identity") +
  theme_bw() +
  labs(title=paste("Landings of DEF by top 10 countries -", RCG), x="year", y="Proportion of landings", fill="Country") +
  theme(axis.text = element_text(size=8), plot.title=element_text(size=11), axis.title=element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9)) 

p2 <- p2 + scale_fill_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

# Landings by gear group (FishingActivityLvl5)

CL_years_def$FishingActivityLvl5_1 <- as.character(CL_years_def$FishingActivityLvl5)
def_gear_top10 <- CL_years_def %>%
  group_by(FishingActivityLvl5_1) %>%
  summarise(lwTot=sum(LandingWeight_ton)) %>%
  arrange(desc(lwTot)) %>%  
  top_n(10) %>% data.frame

def_gear_top10$Top10gear <- "X"
landings_def <- left_join(CL_years_def,def_gear_top10,by="FishingActivityLvl5_1")
landings_def$topGears <- ifelse(is.na(landings_def$Top10gear),"Other gears",landings_def$FishingActivityLvl5_1)

landings_def_sum <- landings_def %>%
  group_by(Year, topGears) %>%
  summarise(Landing_ton=sum(LandingWeight_ton)) %>% arrange(topGears)

p3 <- ggplot(data=landings_def_sum, aes(x=Year, y=Landing_ton, fill=topGears)) +
  geom_bar(position="fill", stat="identity") +
  theme_bw() +
  labs(title=paste("Landings of DEF by top 10 gears -", RCG), x="year", y="Proportion of landings", fill="Métier Level 5") +
  theme(axis.text = element_text(size=8), plot.title=element_text(size=11), axis.title=element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9)) 


# landings by vessel_length

CL_years_def$Loa1 <- as.factor(CL_years_def$VesselLengthCategory)
CL_years_def <- droplevels(CL_years_def[!is.na(CL_years_def$Loa1),])
def_Loa <- CL_years_def %>%
  group_by(Loa1) %>%
  summarise(lwTot=sum(LandingWeight_ton)) %>%
  arrange(desc(lwTot)) %>%  
  data.frame

landings_def_Loa_sum <- CL_years_def %>%
  group_by(Year, Loa1) %>%
  summarise(Landing_ton=sum(LandingWeight_ton)) 


p4 <- landings_def_Loa_sum %>% 
  mutate(Loa1 = factor(Loa1, levels=c('<10','10-<12','12-<18','18-<24','24-<40','>40'))) %>%
  ggplot(aes(x=Year, y=Landing_ton, fill=Loa1)) +
  geom_bar(position="fill", stat="identity") +
  theme_bw() +
  labs(title=paste("Landings of DEF by vessel length -", RCG), x="year", y="Proportion of landings", fill="Vessel Length\n(m)") +
   theme(axis.text = element_text(size=8), plot.title=element_text(size=11), axis.title=element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9)) 

grid.arrange(p1,p2,p3,p4)


```


### Total landings of molluscs (MOL)

```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%", fig.height = 8, fig.width = 10}
CL_years_mol <- droplevels(CL_years[CL_years$Catch_group=='molluscs',])
Landings_mol <- CL_years_mol %>%
  group_by(Year, FlagCountry) %>%
  summarise(LandingWeight_ton=sum(LandingWeight_ton))

p1 <- ggplot(data=Landings_mol, aes(Year, round(LandingWeight_ton,0), colour=FlagCountry)) +
  geom_point() + geom_line(size=1) +
  theme_bw() +
  scale_colour_discrete(guide = 'none') +
 # geom_dl(aes(label = FlagCountry), method = list(dl.trans(x = x + 0.1), "last.points", cex = 0.7)) +
  labs(title=paste("Landings of MOL by country -", RCG), x="year", y="Landings (ton)") +
  theme(axis.text = element_text(size=9), plot.title=element_text(size=11), axis.title = element_text(size=9),legend.position = "none") 

p1 <- p1 + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)


# Landings by Flag Country

CL_years_mol$FlagCountry1 <- as.character(CL_years_mol$FlagCountry)
mol_countries_top10 <- CL_years_mol %>%
  group_by(FlagCountry1) %>%
  summarise(lwTot=sum(LandingWeight_ton)) %>%
  arrange(desc(lwTot)) %>%  
  top_n(10) %>% data.frame

mol_countries_top10$Top10countries <- "X"
landings_mol <- left_join(CL_years_mol,mol_countries_top10,by="FlagCountry1")
landings_mol$topCountries <- ifelse(is.na(landings_mol$Top10countries),"Other countries",landings_mol$FlagCountry1)

landings_mol_sum <- landings_mol %>%
  group_by(Year, topCountries) %>%
  summarise(Landing_ton=sum(LandingWeight_ton)) %>% arrange(topCountries)

p2 <- ggplot(data=landings_mol_sum, aes(x=Year, y=Landing_ton, fill=topCountries)) +
  geom_bar(position="fill", stat="identity") +
  theme_bw() +
  labs(title=paste("Landings of MOL by top 10 countries -", RCG), x="year", y="Proportion of landings", fill="Country") +
  theme(axis.text = element_text(size=8), plot.title=element_text(size=11), axis.title=element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9)) 

p2 <- p2 + scale_fill_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

# Landings by gear group (FishingActivityLvl5)

CL_years_mol$FishingActivityLvl5_1 <- as.character(CL_years_mol$FishingActivityLvl5)
mol_gear_top10 <- CL_years_mol %>%
  group_by(FishingActivityLvl5_1) %>%
  summarise(lwTot=sum(LandingWeight_ton)) %>%
  arrange(desc(lwTot)) %>%  
  top_n(10) %>% data.frame

mol_gear_top10$Top10gear <- "X"
landings_mol <- left_join(CL_years_mol,mol_gear_top10,by="FishingActivityLvl5_1")
landings_mol$topGears <- ifelse(is.na(landings_mol$Top10gear),"Other gears",landings_mol$FishingActivityLvl5_1)

landings_mol_sum <- landings_mol %>%
  group_by(Year, topGears) %>%
  summarise(Landing_ton=sum(LandingWeight_ton)) %>% arrange(topGears)

p3 <- ggplot(data=landings_mol_sum, aes(x=Year, y=Landing_ton, fill=topGears)) +
  geom_bar(position="fill", stat="identity") +
  theme_bw() +
  labs(title=paste("Landings of MOL by top 10 gears -", RCG), x="year", y="Proportion of landings", fill="Métier Level 5") +
  theme(axis.text = element_text(size=8), plot.title=element_text(size=11), axis.title=element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9)) 


# landings by vessel_length

CL_years_mol$Loa1 <- as.factor(CL_years_mol$VesselLengthCategory)
CL_years_mol <- droplevels(CL_years_mol[!is.na(CL_years_mol$Loa1),])
mol_Loa <- CL_years_mol %>%
  group_by(Loa1) %>%
  summarise(lwTot=sum(LandingWeight_ton)) %>%
  arrange(desc(lwTot)) %>%  
  data.frame

landings_mol_Loa_sum <- CL_years_mol %>%
  group_by(Year, Loa1) %>%
  summarise(Landing_ton=sum(LandingWeight_ton)) 


p4 <- landings_mol_Loa_sum %>% 
  mutate(Loa1 = factor(Loa1, levels=c('<10','10-<12','12-<18','18-<24','24-<40','>40'))) %>%
  ggplot(aes(x=Year, y=Landing_ton, fill=Loa1)) +
  geom_bar(position="fill", stat="identity") +
  theme_bw() +
  labs(title=paste("Landings of MOL by vessel length -", RCG), x="year", y="Proportion of landings", fill="Vessel Length\n(m)") +
  theme(axis.text = element_text(size=8), plot.title=element_text(size=11), axis.title=element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9)) 

grid.arrange(p1,p2,p3,p4)


```


### Total landings of Elasmobranch fish (EF)

```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%", fig.height = 8, fig.width = 10}
CL_years_ef <- droplevels(CL_years[CL_years$Catch_group=='elasmobranchs',])
Landings_ef <- CL_years_ef %>%
  group_by(Year, FlagCountry) %>%
  summarise(LandingWeight_ton=sum(LandingWeight_ton))

p1 <- ggplot(data=Landings_ef, aes(Year, round(LandingWeight_ton,0), colour=FlagCountry)) +
  geom_point() + geom_line(size=1) +
  theme_bw() +
  scale_colour_discrete(guide = 'none') +
  #geom_dl(aes(label = FlagCountry), method = list(dl.trans(x = x + 0.1), "last.points", cex = 0.7))+
  labs(title=paste("Landings of EF by country -", RCG), x="year", y="Landings (ton)") +
  theme(axis.text = element_text(size=9), plot.title=element_text(size=11), axis.title = element_text(size=9),legend.position = "none") 

p1 <- p1 + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)


# Landings by Flag Country

CL_years_ef$FlagCountry1 <- as.character(CL_years_ef$FlagCountry)
ef_countries_top10 <- CL_years_ef %>%
  group_by(FlagCountry1) %>%
  summarise(lwTot=sum(LandingWeight_ton)) %>%
  arrange(desc(lwTot)) %>%  
  top_n(10) %>% data.frame

ef_countries_top10$Top10countries <- "X"
landings_ef <- left_join(CL_years_ef,ef_countries_top10,by="FlagCountry1")
landings_ef$topCountries <- ifelse(is.na(landings_ef$Top10countries),"Other countries",landings_ef$FlagCountry1)

landings_ef_sum <- landings_ef %>%
  group_by(Year, topCountries) %>%
  summarise(Landing_ton=sum(LandingWeight_ton)) %>% arrange(topCountries)

p2 <- ggplot(data=landings_ef_sum, aes(x=Year, y=Landing_ton, fill=topCountries)) +
  geom_bar(position="fill", stat="identity") +
  theme_bw() +
  labs(title=paste("Landings of EF by top 10 countries -", RCG), x="year", y="Proportion of landings", fill="Country") +
   theme(axis.text = element_text(size=8), plot.title=element_text(size=11), axis.title=element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9)) 

p2 <- p2 + scale_fill_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

# Landings by gear group (FishingActivityLvl5)

CL_years_ef$FishingActivityLvl5_1 <- as.character(CL_years_ef$FishingActivityLvl5)
ef_gear_top10 <- CL_years_ef %>%
  group_by(FishingActivityLvl5_1) %>%
  summarise(lwTot=sum(LandingWeight_ton)) %>%
  arrange(desc(lwTot)) %>%  
  top_n(10) %>% data.frame

ef_gear_top10$Top10gear <- "X"
landings_ef <- left_join(CL_years_ef,ef_gear_top10,by="FishingActivityLvl5_1")
landings_ef$topGears <- ifelse(is.na(landings_ef$Top10gear),"Other gears",landings_ef$FishingActivityLvl5_1)

landings_ef_sum <- landings_ef %>%
  group_by(Year, topGears) %>%
  summarise(Landing_ton=sum(LandingWeight_ton)) %>% arrange(topGears)

p3 <- ggplot(data=landings_ef_sum, aes(x=Year, y=Landing_ton, fill=topGears)) +
  geom_bar(position="fill", stat="identity") +
  theme_bw() +
  labs(title=paste("Landings of EF by top 10 gears -", RCG), x="year", y="Proportion of landings", fill="Métier Level 5") +
   theme(axis.text = element_text(size=8), plot.title=element_text(size=11), axis.title=element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9)) 


# landings by vessel_length

CL_years_ef$Loa1 <- as.factor(CL_years_ef$VesselLengthCategory)
CL_years_ef <- droplevels(CL_years_ef[!is.na(CL_years_ef$Loa1),])
ef_Loa <- CL_years_ef %>%
  group_by(Loa1) %>%
  summarise(lwTot=sum(LandingWeight_ton)) %>%
  arrange(desc(lwTot)) %>%  
  data.frame

landings_ef_Loa_sum <- CL_years_ef %>%
  group_by(Year, Loa1) %>%
  summarise(Landing_ton=sum(LandingWeight_ton))


p4 <- landings_ef_Loa_sum %>% 
  mutate(Loa1 = factor(Loa1, levels=c('<10','10-<12','12-<18','18-<24','24-<40','>40'))) %>%
  ggplot(aes(x=Year, y=Landing_ton, fill=Loa1)) +
  geom_bar(position="fill", stat="identity") +
  theme_bw() +
  labs(title=paste("Landings of EF by vessel length -", RCG), x="year", y="Proportion of landings", fill="Vessel Length\n(m)") +
  theme(axis.text = element_text(size=8), plot.title=element_text(size=11), axis.title=element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9)) 

grid.arrange(p1,p2,p3,p4)

```


### Total landings of Flatfish (FF)

```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%", fig.height = 8, fig.width = 10}
CL_years_ff <- droplevels(CL_years[CL_years$Catch_group=='flatfish',])
Landings_ff <- CL_years_ff %>%
  group_by(Year, FlagCountry) %>%
  summarise(LandingWeight_ton=sum(LandingWeight_ton))

p1 <- ggplot(data=Landings_ff, aes(Year, round(LandingWeight_ton/1000,0), colour=FlagCountry)) +
  geom_point() + geom_line(size=1) +
  theme_bw() +
  scale_colour_discrete(guide = 'none') +
#  geom_dl(aes(label = FlagCountry), method = list(dl.trans(x = x + 0.1), "last.points", cex = 0.7)) +
  labs(title=paste("Landings of FF by country -", RCG), x="year", y="Landings (thousand ton)") +
  theme(axis.text.x = element_text(size=9), plot.title=element_text(size=11), axis.title = element_text(size=9),legend.position = "none") 

p1 <- p1 + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)


# Landings by Flag Country

CL_years_ff$FlagCountry1 <- as.character(CL_years_ff$FlagCountry)
ff_countries_top10 <- CL_years_ff %>%
  group_by(FlagCountry1) %>%
  summarise(lwTot=sum(LandingWeight_ton)) %>%
  arrange(desc(lwTot)) %>%  
  top_n(10) %>% data.frame

ff_countries_top10$Top10countries <- "X"
landings_ff <- left_join(CL_years_ff,ff_countries_top10,by="FlagCountry1")
landings_ff$topCountries <- ifelse(is.na(landings_ff$Top10countries),"Other countries",landings_ff$FlagCountry1)

landings_ff_sum <- landings_ff %>%
  group_by(Year, topCountries) %>%
  summarise(Landing_ton=sum(LandingWeight_ton)) %>% arrange(topCountries)

p2 <- ggplot(data=landings_ff_sum, aes(x=Year, y=Landing_ton, fill=topCountries)) +
  geom_bar(position="fill", stat="identity") +
  theme_bw() +
  labs(title=paste("Landings of FF by top 10 countries -", RCG), x="year", y="Proportion of landings", fill="Country") +
   theme(axis.text = element_text(size=8), plot.title=element_text(size=11), axis.title=element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9)) 

p2 <- p2 + scale_fill_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

# Landings by gear group (FishingActivityLvl5)

CL_years_ff$FishingActivityLvl5_1 <- as.character(CL_years_ff$FishingActivityLvl5)
ff_gear_top10 <- CL_years_ff %>%
  group_by(FishingActivityLvl5_1) %>%
  summarise(lwTot=sum(LandingWeight_ton)) %>%
  arrange(desc(lwTot)) %>%  
  top_n(10) %>% data.frame

ff_gear_top10$Top10gear <- "X"
landings_ff <- left_join(CL_years_ff,ff_gear_top10,by="FishingActivityLvl5_1")
landings_ff$topGears <- ifelse(is.na(landings_ff$Top10gear),"Other gears",landings_ff$FishingActivityLvl5_1)

landings_ff_sum <- landings_ff %>%
  group_by(Year, topGears) %>%
  summarise(Landing_ton=sum(LandingWeight_ton)) %>% arrange(topGears)

p3 <- ggplot(data=landings_ff_sum, aes(x=Year, y=Landing_ton, fill=topGears)) +
  geom_bar(position="fill", stat="identity") +
  theme_bw() +
  labs(title=paste("Landings of FF by top 10 gears -", RCG), x="year", y="Proportion of landings", fill="Métier Level 5") +
  theme(axis.text = element_text(size=8), plot.title=element_text(size=11), axis.title=element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9)) 


# landings by vessel_length

CL_years_ff$Loa1 <- as.factor(CL_years_ff$VesselLengthCategory)
CL_years_ff <- droplevels(CL_years_ff[!is.na(CL_years_ff$Loa1),])
ff_Loa <- CL_years_ff %>%
  group_by(Loa1) %>%
  summarise(lwTot=sum(LandingWeight_ton)) %>%
  arrange(desc(lwTot)) %>%  
  data.frame

landings_ff_Loa_sum <- CL_years_ff %>%
  group_by(Year, Loa1) %>%
  summarise(Landing_ton=sum(LandingWeight_ton)) 


p4 <- landings_ff_Loa_sum %>% 
  mutate(Loa1 = factor(Loa1, levels=c('<10','10-<12','12-<18','18-<24','24-<40','>40'))) %>%
  ggplot(aes(x=Year, y=Landing_ton, fill=Loa1)) +
  geom_bar(position="fill", stat="identity") +
  theme_bw() +
  labs(title=paste("Landings of FF by vessel length -", RCG), x="year", y="Proportion of landings", fill="Vessel Length\n(m)") +
  theme(axis.text = element_text(size=8), plot.title=element_text(size=11), axis.title=element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9)) 

grid.arrange(p1,p2,p3,p4)

```

### Total landings of Large Pelagic fish (LPF)

```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%", fig.height = 8, fig.width = 10}
CL_years_lpf <- droplevels(CL_years[CL_years$Catch_group=='large pelagic',])
Landings_lpf <- CL_years_lpf %>%
  group_by(Year, FlagCountry) %>%
  summarise(LandingWeight_ton=sum(LandingWeight_ton))

p1 <- ggplot(data=Landings_lpf, aes(Year, round(LandingWeight_ton,0), colour=FlagCountry)) +
  geom_point() + geom_line(size=1) +
  theme_bw() +
  scale_colour_discrete(guide = 'none') +
  #geom_dl(aes(label = FlagCountry), method = list(dl.trans(x = x + 0.1), "last.points", cex = 0.7))+
  labs(title=paste("Landings of LPF fish by country -", RCG), x="year", y="Landings (ton)") +
  theme(axis.text.x = element_text(size=9), plot.title=element_text(size=11), axis.title = element_text(size=9),legend.position = "none") 

p1 <- p1 + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)


# Landings by Flag Country

CL_years_lpf$FlagCountry1 <- as.character(CL_years_lpf$FlagCountry)
lpf_countries_top10 <- CL_years_lpf %>%
  group_by(FlagCountry1) %>%
  summarise(lwTot=sum(LandingWeight_ton)) %>%
  arrange(desc(lwTot)) %>%  
  top_n(10) %>% data.frame

lpf_countries_top10$Top10countries <- "X"
landings_lpf <- left_join(CL_years_lpf,lpf_countries_top10,by="FlagCountry1")
landings_lpf$topCountries <- ifelse(is.na(landings_lpf$Top10countries),"Other countries",landings_lpf$FlagCountry1)

landings_lpf_sum <- landings_lpf %>%
  group_by(Year, topCountries) %>%
  summarise(Landing_ton=sum(LandingWeight_ton)) %>% arrange(topCountries)

p2 <- ggplot(data=landings_lpf_sum, aes(x=Year, y=Landing_ton, fill=topCountries)) +
  geom_bar(position="fill", stat="identity") +
  theme_bw() +
  labs(title=paste("Landings of LPF by top 10 countries -", RCG), x="year", y="Proportion of landings", fill="Country") +
  theme(axis.text = element_text(size=8), plot.title=element_text(size=11), axis.title=element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9)) 

p2 <- p2 + scale_fill_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

# Landings by gear group (FishingActivityLvl5)

CL_years_lpf$FishingActivityLvl5_1 <- as.character(CL_years_lpf$FishingActivityLvl5)
lpf_gear_top10 <- CL_years_lpf %>%
  group_by(FishingActivityLvl5_1) %>%
  summarise(lwTot=sum(LandingWeight_ton)) %>%
  arrange(desc(lwTot)) %>%  
  top_n(10) %>% data.frame

lpf_gear_top10$Top10gear <- "X"
landings_lpf <- left_join(CL_years_lpf,lpf_gear_top10,by="FishingActivityLvl5_1")
landings_lpf$topGears <- ifelse(is.na(landings_lpf$Top10gear),"Other gears",landings_lpf$FishingActivityLvl5_1)

landings_lpf_sum <- landings_lpf %>%
  group_by(Year, topGears) %>%
  summarise(Landing_ton=sum(LandingWeight_ton)) %>% arrange(topGears)

p3 <- ggplot(data=landings_lpf_sum, aes(x=Year, y=Landing_ton, fill=topGears)) +
  geom_bar(position="fill", stat="identity") +
  theme_bw() +
  labs(title=paste("Landings of LPF by top 10 gears -", RCG), x="year", y="Proportion of landings", fill="Métier Level 5") +
  theme(axis.text = element_text(size=8), plot.title=element_text(size=11), axis.title=element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9)) 


# landings by vessel_length

CL_years_lpf$Loa1 <- as.factor(CL_years_lpf$VesselLengthCategory)
CL_years_lpf <- droplevels(CL_years_lpf[!is.na(CL_years_lpf$Loa1),])
lpf_Loa <- CL_years_lpf %>%
  group_by(Loa1) %>%
  summarise(lwTot=sum(LandingWeight_ton)) %>%
  arrange(desc(lwTot)) %>%  
  data.frame

landings_lpf_Loa_sum <- CL_years_lpf %>%
  group_by(Year, Loa1) %>%
  summarise(Landing_ton=sum(LandingWeight_ton))

p4 <- landings_lpf_Loa_sum %>% 
  mutate(Loa1 = factor(Loa1, levels=c('<10','10-<12','12-<18','18-<24','24-<40','>40'))) %>%
  ggplot(aes(x=Year, y=Landing_ton, fill=Loa1)) +
  geom_bar(position="fill", stat="identity") +
  theme_bw() +
  labs(title=paste("Landings of LPF by vessel length -", RCG), x="year", y="Proportion of landings", fill="Vessel Length\n(m)") +
  theme(axis.text = element_text(size=8), plot.title=element_text(size=11), axis.title=element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9)) 

grid.arrange(p1,p2,p3,p4)

```

### Total Landings of Diadromous (DIA)

```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%", fig.height = 8, fig.width = 10}
CL_years_dia <- droplevels(CL_years[CL_years$Catch_group=='diadromous',])
Landings_dia <- CL_years_dia %>%
  group_by(Year, FlagCountry) %>%
  summarise(LandingWeight_ton=sum(LandingWeight_ton))

p1 <- ggplot(data=Landings_dia, aes(Year, round(LandingWeight_ton,0), colour=FlagCountry)) +
  geom_point() + geom_line(size=1) +
  theme_bw() +
  scale_colour_discrete(guide = 'none') +
 # geom_dl(aes(label = FlagCountry), method = list(dl.trans(x = x + 0.1), "last.points", cex = 0.7))+
  labs(title=paste("Landings of DIA fish by country -", RCG), x="year", y="Landings (ton)") +
  theme(axis.text.x = element_text(size=9), plot.title=element_text(size=11), axis.title = element_text(size=9),legend.position = "none") 

p1 <- p1 + scale_color_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)


# Landings by Flag Country

CL_years_dia$FlagCountry1 <- as.character(CL_years_dia$FlagCountry)
dia_countries_top10 <- CL_years_dia %>%
  group_by(FlagCountry1) %>%
  summarise(lwTot=sum(LandingWeight_ton)) %>%
  arrange(desc(lwTot)) %>%  
  top_n(10) %>% data.frame

dia_countries_top10$Top10countries <- "X"
landings_dia <- left_join(CL_years_dia,dia_countries_top10,by="FlagCountry1")
landings_dia$topCountries <- ifelse(is.na(landings_dia$Top10countries),"Other countries",landings_dia$FlagCountry1)

landings_dia_sum <- landings_dia %>%
  group_by(Year, topCountries) %>%
  summarise(Landing_ton=sum(LandingWeight_ton)) %>% arrange(topCountries)

p2 <- ggplot(data=landings_dia_sum, aes(x=Year, y=Landing_ton, fill=topCountries)) +
  geom_bar(position="fill", stat="identity") +
  theme_bw() +
  labs(title=paste("Landings of DIA fish by top 10 countries -", RCG), x="year", y="Proportion of landings", fill="Country") +
  theme(axis.text = element_text(size=8), plot.title=element_text(size=11), axis.title=element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9)) 

p2 <- p2 + scale_fill_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

# Landings by gear group (FishingActivityLvl5)

CL_years_dia$FishingActivityLvl5_1 <- as.character(CL_years_dia$FishingActivityLvl5)
dia_gear_top10 <- CL_years_dia %>%
  group_by(FishingActivityLvl5_1) %>%
  summarise(lwTot=sum(LandingWeight_ton)) %>%
  arrange(desc(lwTot)) %>%  
  top_n(10) %>% data.frame

dia_gear_top10$Top10gear <- "X"
landings_dia <- left_join(CL_years_dia,dia_gear_top10,by="FishingActivityLvl5_1")
landings_dia$topGears <- ifelse(is.na(landings_dia$Top10gear),"Other gears",landings_dia$FishingActivityLvl5_1)

landings_dia_sum <- landings_dia %>%
  group_by(Year, topGears) %>%
  summarise(Landing_ton=sum(LandingWeight_ton)) %>% arrange(topGears)

p3 <- ggplot(data=landings_dia_sum, aes(x=Year, y=Landing_ton, fill=topGears)) +
  geom_bar(position="fill", stat="identity") +
  theme_bw() +
  labs(title=paste("Landings of DIA by top 10 gears -", RCG), x="year", y="Proportion of landings", fill="Métier Level 5") +
  theme(axis.text = element_text(size=8), plot.title=element_text(size=11), axis.title=element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9)) 


# landings by vessel_length

CL_years_dia$Loa1 <- as.factor(CL_years_dia$VesselLengthCategory)
CL_years_dia <- droplevels(CL_years_dia[!is.na(CL_years_dia$Loa1),])
dia_Loa <- CL_years_dia %>%
  group_by(Loa1) %>%
  summarise(lwTot=sum(LandingWeight_ton)) %>%
  arrange(desc(lwTot)) %>%  
  data.frame

landings_dia_Loa_sum <- CL_years_dia %>%
  group_by(Year, Loa1) %>%
  summarise(Landing_ton=sum(LandingWeight_ton)) 

p4 <- landings_dia_Loa_sum %>% 
  mutate(Loa1 = factor(Loa1, levels=c('<10','10-<12','12-<18','18-<24','24-<40','>40'))) %>%
  ggplot(aes(x=Year, y=Landing_ton, fill=Loa1)) +
  geom_bar(position="fill", stat="identity") +
  theme_bw() +
  labs(title=paste("Landings of DIA by vessel length -", RCG), x="year", y="Proportion of landings", fill="Vessel Length\n(m)") +
  theme(axis.text = element_text(size=8), plot.title=element_text(size=11), axis.title=element_text(size=9),legend.title=element_text(size=10),legend.text=element_text(size=9)) 

grid.arrange(p1,p2,p3,p4)

```

## Landings by Species {.tabset}

The main landed species in weight, in `r title_stock` are presented in the interactive plots below. The first three panels show the top 10 species present in the landings of the region, using different layouts. In panel 1 the lines represent the variation of weights by year of the main species landed; panel 2 shows te variation of the total volume and species composition of the landings by year; panel 3 presents the variation of the proportion of the main species in the overall landings for the reference period. The last panel presents the countries that contribute for the landings of the main landed species in weight (top 10) in the `r title_stock`.

### 1 Total landings top 10 species  
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%", fig.height = 8, fig.width = 10}
CL_years$Species1 <- as.character(CL_years$Species)
top10_species <- CL_years %>%
  group_by(Species1) %>%
  summarise(lwTot=sum(LandingWeight_ton)) %>%
  arrange(desc(lwTot)) %>%
  top_n(10)
top10_species$Top10species <- "X"
landings_sp <- left_join(CL_years,top10_species,by="Species1")
landings_sp$topSpecies <- ifelse(is.na(landings_sp$Top10species),"Other species",landings_sp$Species1)

landings_sp_sum <- landings_sp %>%
  group_by(Year, topSpecies) %>%
  summarise(Landing_ton=sum(LandingWeight_ton))

land1 <- ggplot(data=landings_sp_sum, aes(Year, round(Landing_ton/1000,0), colour=topSpecies)) +
  geom_point() + geom_line() +
  theme_bw() +
  labs(title=paste("Landings by top 10 species -", RCG), x="year", y="Landings (thousand ton)", colour="Top 10 Species") + 
  theme(axis.text.x = element_text(size=7), plot.title=element_text(size=9), axis.title = element_text(size=8)) 

ggplotly(land1)

```

### 2 Landings composition top 10 species  
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%", fig.height = 8, fig.width = 10}
CL_years$Species1 <- as.character(CL_years$Species)
top10_species <- CL_years %>%
  group_by(Species1) %>%
  summarise(lwTot=sum(LandingWeight_ton)) %>%
  arrange(desc(lwTot)) %>%
  top_n(10)
top10_species$Top10species <- "X"
landings_sp <- left_join(CL_years,top10_species,by="Species1")
landings_sp$topSpecies <- ifelse(is.na(landings_sp$Top10species),"Other species",landings_sp$Species1)

landings_sp_sum <- landings_sp %>%
  group_by(Year, topSpecies) %>%
  summarise(Landing_ton=sum(LandingWeight_ton))

land2 <- ggplot(data=landings_sp_sum, aes(x=Year, y=round(Landing_ton/1000,0), fill=topSpecies)) +
  geom_bar(position="stack", stat="identity") +
  theme_bw() +
  labs(title=paste("Landings by top 10 species -", RCG), x="year", y="Landings (thousand ton)", fill="Top 10 Species") +
  theme(axis.text.x = element_text(size=7), plot.title=element_text(size=9), axis.title = element_text(size=8)) 

ggplotly(land2)

```

### 3 Landings proportions top 10 species
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%", fig.height = 8, fig.width = 10}
CL_years$Species1 <- as.character(CL_years$Species)
top10_species <- CL_years %>%
  group_by(Species1) %>%
  summarise(lwTot=sum(LandingWeight_ton)) %>%
  arrange(desc(lwTot)) %>%
  top_n(10)
top10_species$Top10species <- "X"
landings_sp <- left_join(CL_years,top10_species,by="Species1")
landings_sp$topSpecies <- ifelse(is.na(landings_sp$Top10species),"Other species",landings_sp$Species1)

landings_sp_sum <- landings_sp %>%
  group_by(Year, topSpecies) %>%
  summarise(Landing_ton=sum(LandingWeight_ton))

land3 <- ggplot(data=landings_sp_sum, aes(x=Year, y=Landing_ton, fill=topSpecies)) +
  geom_bar(position="fill", stat="identity") +
  theme_bw() +
  labs(title=paste("Landings by top 10 species -", RCG), x="year", y="Proportion of landings", fill="Top 10 Species")+
  theme(axis.text.x = element_text(size=7), plot.title=element_text(size=9), axis.title = element_text(size=8))

ggplotly(land3)

```

### 4 Landings by country top 10 species
```{r echo=FALSE, message=FALSE, warning=FALSE, out.height="95%", out.width="95%"}
CL_years$Species1 <- as.character(CL_years$Species)
top10_species <- CL_years %>%
  group_by(Species1) %>%
  summarise(lwTot=sum(LandingWeight_ton)) %>%
  arrange(desc(lwTot)) %>%
  top_n(10)
top10_species$Top10species <- "X"
landings_sp <- left_join(CL_years,top10_species,by="Species1")
landings_sp$topSpecies <- ifelse(is.na(landings_sp$Top10species),"Other species",landings_sp$Species1)

landings_sp_sum <- landings_sp %>%
  group_by(Year, FlagCountry, topSpecies) %>%
  summarise(Landing_ton=sum(LandingWeight_ton))

land4 <- ggplot(data=landings_sp_sum, aes(x=Year, y=Landing_ton, fill=FlagCountry)) +
  geom_bar(position="fill", stat="identity") +
  theme_bw() +
  facet_wrap(~topSpecies)+
  labs(title=paste("Landings by top 10 species -", RCG), x="year", y="Proportion of landings", fill="Country") +
 theme(axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), plot.title=element_text(size=11), axis.title=element_text(size=9),legend.title=element_text(size=9),legend.text=element_text(size=8),strip.text = element_text(size = 8), panel.spacing.y = unit(2,"lines"))#, panel.spacing.x = unit(2,"lines"), panel.spacing.y = unit(3,"lines")) 

land4 <- land4 + scale_fill_manual(breaks = aux_colours_ggplot$Country,
        values = aux_colours_ggplot$colour5)

ggplotly(land4)

```

## {-}


## Landings by Stock {.tabset}
The following chapter refers to the multiannual stocks’ distribution for `r title_stock`. 

*Warning*: This stock allocation represents variable stock denominations which were adjusted by the group accordingly with procedures discussed within ICES community and, therefore some of them do not come directly from the RDB. For the species that don´t have a stock assigned, a new stock denomination was created by joining the FAO code (or scientific name when no FAO code exists) with the fishing ground.


### Table: Landings by country top 5 stocks

The table below summarizes the top 5 stocks in landing’s volume per country and by year for the period `r years[1]`-`r years[6]`. This stock information has been developed for the last five years, and so adjustments and definitions are being worked ever since. Landings per stock ("Landings") and total landings of all stocks by country and year ("Total") are presented in thousand tons. 

```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="95%", out.height="95%"}
Def_stock$Code = as.character(Def_stock$Code)
Def_stock$ID<- paste(Def_stock$area, Def_stock$AphiaID, sep='')
CL_years$SpeciesAphiaID<-as.character(CL_years$SpeciesAphiaID)
CL_years$ID <- paste(CL_years$Area, CL_years$SpeciesAphiaID, sep='')
temp<-left_join(CL_years,Def_stock, by='ID', all.x=TRUE)

#temp$new_stock<-ifelse(is.na(temp$Code) & !is.na(temp$stockNew),temp$stockNew,temp$Code)

#ASFIS_WoRMS_updt <- read.table (file="D:/Documents/PNAB/2022/000_RCG_InterssessionalWork/ISSG_Catch_Effort_Sampling_overviews/ISSG_overviews/RegionalOverviews/data/ASFIS_WoRMS_updt.csv", header=T, sep=";", stringsAsFactors=FALSE)	

ASFIS_WoRMS_updt <- read.table (file="C:/Use/0_GitHub/RCGs/RegionalOverviews/data/ASFIS_WoRMS_updt.csv", header=T, sep=";", stringsAsFactors=FALSE)	# lucia's pc

## Adds Fao code where missing...
# link to aphia
temp[is.na(temp$sppFAO),]$sppFAO <- ASFIS_WoRMS_updt$X3A_CODE[match(temp[is.na(temp$sppFAO),]$SpeciesAphiaID,ASFIS_WoRMS_updt$AphiaID)]

# link to species name
temp[is.na(temp$sppFAO),]$sppFAO <- ASFIS_WoRMS_updt$X3A_CODE[match(temp[is.na(temp$sppFAO),]$Species,ASFIS_WoRMS_updt$ScientificName)]
## 25 spp without FAO code

# creates stock code with Fao+Area; for spp without Fao Code gets the scientific name and area to create the code
temp$new_stockplus<-ifelse(is.na(temp$stockNew),paste(temp$Species,temp$FishingGround,sep='.'),temp$stockNew)

# Dealing with herring stock, where area was reported as 27.3.d.28 - we have no knowledge if it was 27.3.d.28.1 or 27.3.d.28.2 # Nuno corrected this after RCG 2021
# Now we're assuming that it was stock ‘her.27.25-2932’
  #temp$new_stockplus<- ifelse(temp$new_stockplus == "her-2529+32(-GOR)", "her.27.25-2932", temp$new_stockplus)

temp<-temp[,c('Year','FlagCountry','OfficialLandingCatchWeight','new_stockplus','FishingGround','SpeciesDesc')]
temp%>%
  group_by(Year,FlagCountry,new_stockplus,FishingGround,SpeciesDesc)%>%
  rename(Stock=new_stockplus)%>%
  summarise(Landing=sum(OfficialLandingCatchWeight, na.rm = T))->temp1
temp1%>%
  group_by(Year,FlagCountry)%>%
  summarise(Total=sum(Landing, na.rm = T))->temp2

result<-merge(temp1,temp2)  
result$percent<-result$Landing/result$Total
result$percent<-label_percent()(result$percent)

top5 = result %>% group_by(Year,FlagCountry)%>% top_n(5,Landing) # to table
top5$Landing<-round(top5$Landing/1000,0)
top5$Total<-round(top5$Total/1000,0)
DT::datatable(top5, filter = list(
  position = 'top', clear = FALSE
))

```

### Figure: Landings by top 10 stocks
This set of graphs refer to the landing’s proportion of the top 10 stocks per flag country. The main goal of this topic is to present how those stock landings are distributed among countries and analyse the evolution of the landings by stock in the reference period (`r years[1]` - `r years[6]`). It also gives some indications on the stock incidence history per flag country.

```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="95%", out.height="95%"}
top10_stock <- temp1 %>%
  group_by(Stock) %>%
  summarise(lan_stock=sum(Landing)) %>%
  arrange(desc(lan_stock)) %>%
  top_n(10)

top10_stock$Top10stock <- "X"
landings_stock <- left_join(temp1,top10_stock,by="Stock")
landings_stock$topstock <- ifelse(is.na(landings_stock$Top10stock),"Not_top",landings_stock$Stock)

landings_stock_sum <- landings_stock %>%
  group_by(Year,FlagCountry, topstock) %>%
  summarise(Landing_s=sum(Landing))

landTop10 <- ggplot(data=landings_stock_sum, aes(x=Year, y=round(Landing_s/1000,0), fill=FlagCountry)) +
  geom_bar(position="fill", stat="identity") +
  theme_bw() +
  facet_wrap(~topstock)+
  labs(title=paste("Landings by top 10 stocks -", RCG), x="year", y="Proportion of landings", fill="Country")+
  theme(axis.text.x = element_text(size=8), axis.text.y = element_text(size=8), plot.title=element_text(size=11), axis.title=element_text(size=9),legend.title=element_text(size=9),legend.text=element_text(size=8),strip.text = element_text(size = 8), panel.spacing.y = unit(2,"lines"))

ggplotly(landTop10)

```

## Appendix A. Dates of data extraction

The data referring to the present year was collected under the RCG 2022 data call for the 2021 data for the Baltic Sea, North Sea, Eastern Arctic and the North Atlantic regions and downloaded from the system on the 17th of April 2022 with the exception of information detailed in section “Overall fleet evolution” which was extracted from the EU Fleet Register (https://webgate.ec.europa.eu/fleet-europa/index_en) on the 11th of March 2022.

## {-}

## Appendix B. Glossary for the country codes

```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}

country_table <-  read.table(
    #"D:/Documents/PNAB/2022/000_RCG_InterssessionalWork/ISSG_Catch_Effort_Sampling_overviews/ISSG_overviews/RegionalOverviews/data/aux_countries.txt",
    "C:/Use/0_GitHub/RCGs/RegionalOverviews/data//aux_countries.txt",  # lucia's pc
    header = T,
    sep = ",",
    colClasses = "character",
    na.strings = "",
    comment.char = ""
  )
 
table_out <- droplevels(country_table[country_table$ISO3Code %in% CL_years$FlagCountry | country_table$ISO3Code %in% CL_years$LandingCountry,])
table_out <- table_out[,c('Country','ISO3Code')]

kable(table_out, row.names=F, col.names = c('Name','Code'),format = "html", table.attr = "style='width:30%;'")

```


