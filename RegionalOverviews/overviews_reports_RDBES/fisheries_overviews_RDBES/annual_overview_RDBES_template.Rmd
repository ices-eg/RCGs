---
title: "RDBES Catch and Effort Overview"
date: "`r format(Sys.time(), '%d.%m.%Y')`"
output:
  html_document:
    toc: true
    
params:
  set_subtitle: "Title"
  region: 'BA'
  year: 2021
  logo_path: "../../overviews_shiny/www/logo RCG BALTIC.PNG"
  data_dir: '../../data_RDBES/002_prepared/20240129/RCG_BA'
  RDBES_download_date: '01/01/2000'
  CLfileName: 'RDBES_RCG_BA_CL_2021_2021_prepared_20240129'
  CEfileName: 'RDBES_RCG_BA_CE_2021_2021_prepared_20240129'
  
---

---
subtitle: `r paste(dplyr::case_when(params$region=='BA'~'Baltic',params$region=='NA'~'North Atlantic',params$region=='NSEA'~'North Sea and Eastern Arctic'), params$year, sep = ", ")`
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE)
```

```{r, echo=FALSE}
  htmltools::img(src = knitr::image_uri(params$logo_path), 
               alt = 'logo', 
               style = 'position:absolute; top:0; right:0; padding:10px;',width="300px", height="100px")
```

```{r loadPackages, echo=FALSE, message=FALSE, warning=FALSE}
# LOAD PACKAGES AND DEFINE EVAL_PARAMETERS IF NEEDED

library(tidyverse)
# library(car)
# library(ggrepel)
# library(knitr)
# library(kableExtra)
library(data.table)
library(rnaturalearth)
# library(magrittr)
# library(plotly)
# library(leaflet)

 ## establish conditions  - can use it if for example some chunks should be run only for selected Regions, e.g. only Bal
 eval_region_BA <- params$region=='BA' # when added to the chunk header, the chunk will be run only for BA report
 eval_region_NA <- params$region=='NA' # when added to the chunk header, the chunk will be run only for NA report
 eval_region_NSEA <- params$region=='NSEA' # when added to the chunk header, the chunk will be run only for NSEA report

```


```{r GlobalSettings, echo=FALSE}
# DEFINE GLOBAL PARAMETERS/FUNCTIONS FOR DISPLAYING TABLES/PLOTS/MAPS/...

```

```{r loadFunctions, echo=FALSE}
# LOAD FUNCTIONS GENERATING PLOTS/MAPS
source("../../funs_RDBES/choroplethMap_func2.R", local = knitr::knit_global())

```

```{r mapData, echo=FALSE}
# LOAD DATA NEEDED FOR MAPS (shp, rdata, ...) FOR ALL RCGs

```

```{r mapDataBA, include = F, eval=eval_region_BA}
# LOAD PREPARE DATA NEEDED FOR MAPS (shp, rdata, ...) ONLY FOR RCG BA
StatRectshp  = sf::st_read("../../data/shapefiles/RCG_BA_ICESrect.shp")# for BA maps on DIVISIONS level -> WATCH OUT ...28.1/...28.2

FAOshp  = sf::st_read("../../data/shapefiles/RCG_BA_FAOareas.shp") %>% filter(F_LEVEL == 'SUBDIVISION') # for BA maps on DIVISIONS level -> WATCH OUT ...28.1/...28.2
```

```{r mapDataNA,include = F, eval=eval_region_NA}
# LOAD DATA NEEDED FOR MAPS (shp, rdata, ...) ONLY FOR RCG NA
StatRectshp  = sf::st_read("../../data/shapefiles/RCG_NA_ICESrect.shp")

FAOshp  = sf::st_read("../../data/shapefiles/RCG_NA_FAOareas.shp") %>% filter(F_LEVEL == 'DIVISION') # for NA maps on DIVISIONS level

```

```{r mapDataNSEA, include = F, eval=eval_region_NSEA}
# LOAD DATA NEEDED FOR MAPS (shp, rdata, ...) ONLY FOR RCG NSEA
StatRectshp  = sf::st_read("../../data/shapefiles/RCG_NSEA_ICESrect.shp")

FAOshp  = sf::st_read("../../data/shapefiles/RCG_NSEA_FAOareas.shp") %>%  filter(F_LEVEL == 'DIVISION' |
                                                                                   F_LEVEL == 'SUBAREA' |
                                                                                   F_CODE == '27.3.a.20' | 
                                                                                   F_CODE == '27.3.a.21')

```

```{r mapDataPrepare, echo=FALSE, warning = FALSE, message = FALSE}
# PREPARE DATA NEEDED FOR MAPS (shp, rdata, ...)
#StatRectshp %>% mutate(StatisticalRectangle = ICESNAME) -> StatRectshp
StatRectshp = cbind(StatRectshp,  sf::st_coordinates(sf::st_centroid(StatRectshp$geometry))) %>% rename(lon = X, lat = Y)

FAOshp = cbind(FAOshp,  sf::st_coordinates(sf::st_centroid(FAOshp$geometry))) %>% rename(lon = X, lat = Y)

if(params$region=='BA'){ # fixed wrong calculation of centroid of 27.3.d.30
  FAOshp = FAOshp %>%   
    mutate(lon = ifelse(F_CODE=='27.3.d.30', 19.5 ,lon), lat =  ifelse(F_CODE=='27.3.d.30',62 ,lat))

}

```

```{r loadPrepareData, echo=FALSE}
# LOAD AND PREPARE DATA
source('scripts/loadData.R', local = knitr::knit_global())
  
```

```{r fleetRegisterData, echo=FALSE}
# LOAD AND PREPARE FLEET REGISTER DATA

```




**Disclaimer**
put some text here

# Introduction
put some text here

## Reading the graphs
### Barplots
put some text here

### Maps
put some text here

# Overall fleet evolution (All RCGs){.tabset}

## Number of vessels
**Table 1.**put some text here
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}

```

## Power
**Table 2.** put some text here
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}

```

## Gross tonnage
**Table 3.** put some text here
```{r echo=FALSE, message=FALSE, warning = FALSE, out.width="90%", out.height="90%"}

```


# Landings (CL)

## Overall landings

### Landings by species {.tabset}
#### species
#### species and country


### Landings by catch_group {.tabset}
#### catch group
#### catch_group and country

### Landings by fleet

### Landings by area {.tabset}
#### area
#### area and country
#### country and area

### Landings by metier {.tabset}
#### metier lvl5
#### metier lvl5 and country
#### metier lvl6
#### metier lvl6 and country

### Landings by harbour {.tabset}
#### harbour
#### harbour and flag country
#### map - harbour
#### map - harbour and flag country

### Landings abroad

### Spatial distribution of landings

```{r, echo = FALSE, warning = FALSE, message = FALSE, results = "asis", dpi=100, fig.width=6,fig.height=6}
# do we need information on for how many rows(%) there was a missing CLscientificWeight_ton? <-------------------------- to do

# data prep
cl %>%
  group_by(CLyear, CLstatisticalRectangle) %>%
  summarise(CLscientificWeight_ton = sum(CLscientificWeight_ton)) %>%
  mutate(pr= CLscientificWeight_ton/sum(CLscientificWeight_ton, na.rm = TRUE)*100,
         analysis_type = 'sum',
         type_of_threshold = 'none',
         value_of_threshold = NA)-> df

# map
result = choroplethMap_func2(
  df,
  var_name = 'CLscientificWeight_ton',
  var_spatial_name = 'CLstatisticalRectangle',
  facet_name = 'CLyear',
  spatial_dataset_name = 'StatRectshp',
  spatial_dataset_var_name = 'ICESNAME',
  spatial_dataset_labels = FALSE,
  saveResults = FALSE,
  outputPath,
  displayInR = TRUE,
  extraShp_name = 'FAOshp',
  var_name_new = NA,
  addToTitle = NA,
  RCGregion = 'BA'
)

result[[1]]
```

## Small pelagics landings

### Landings by country, small pelagics

### Landings by species, small pelagics {.tabset}
#### species
#### species and country

### Landings by fleet, small pelagics {.tabset}
#### fleet
#### country and fleet
#### fleet and country

### Landings by area, small pelagics {.tabset}
#### area
#### area and country
#### country and area
#### map area
#### map area and flag country

### Landings by metier, small pelagics {.tabset}
#### metier lvl5
#### metier lvl5 and country
#### metier lvl6
#### metier lvl6 and country

### Landings by harbour, small pelagics {.tabset}
#### harbour
#### harbour and flag country
#### map - harbour
#### map - harbour and flag country

### Landings abroad, small pelagics

### Spatial distribution of landings, small pelagics


## Demersal landings (without flatfish)

### Landings by country, demersal (without flatfish)

### Landings by species, demersal (without flatfish) {.tabset}
#### species
#### species and country

### Landings by fleet, demersal (without flatfish) {.tabset}
#### fleet
#### country and fleet
#### fleet and country

### Landings by area, demersal (without flatfish) {.tabset}
#### area
#### area and country
#### country and area
#### map area
#### map area and flag country

### Landings by metier, demersal (without flatfish) {.tabset}
#### metier lvl5
#### metier lvl5 and country
#### metier lvl6
#### metier lvl6 and country

### Landings by harbour, demersal (without flatfish) {.tabset}
#### harbour
#### harbour and flag country
#### map - harbour
#### map - harbour and flag country

### Landings abroad, demersal (without flatfish)

### Spatial distribution of landings, demersal (without flatfish)


## Flatfish landings

### Landings by country, flatfish

### Landings by species, flatfish {.tabset}
#### species
#### species and country

### Landings by fleet, flatfish {.tabset}
#### fleet
#### country and fleet
#### fleet and country

### Landings by area, flatfish {.tabset}
#### area
#### area and country
#### country and area
#### map area
#### map area and flag country

### Landings by metier, flatfish {.tabset}
#### metier lvl5
#### metier lvl5 and country
#### metier lvl6
#### metier lvl6 and country

### Landings by harbour, flatfish {.tabset}
#### harbour
#### harbour and flag country
#### map - harbour
#### map - harbour and flag country

### Landings abroad, flatfish

### Spatial distribution of landings, flatfish


# Effort (CE)

## Effort by country {.tabset}
### number of trips
### days at sea
### KW-days
### GT-days

## Effort by fleet {.tabset}
### number of trips
### number of trips by country and fleet
### number of trips by fleet and country

## Effort by area
### Below 10 meters {.tabset}
#### area
#### area and country
#### country and area

### 10 meteres and above {.tabset}
#### area
#### area and country
#### country and area


## Effort by metier
### Below 10 meters  {.tabset}
#### metier lvl 5
#### metier lvl 5 and country
#### statistical rectangle

### 10 meteres and above  {.tabset}
#### metier lvl 5
#### metier lvl 5 and country
#### statistical rectangle

## Effort by harbour
### Below 10 meters {.tabset}
#### harbour
#### harbour and country
#### map - harbour

### 10 meteres and above {.tabset}
#### harbour
#### harbour and country
#### map - harbour

## Spatal distribution on effort {.tabset}
### Below 10 meters

```{r, echo = FALSE, warning = FALSE, message = FALSE, results = "asis", dpi=100, fig.width=6,fig.height=6}
# data prep
ce %>%
  filter(CEvesselLengthCategory %in% c("VL0006", "VL0608", "VL0810")) %>% 
  group_by(CEyear, CEstatisticalRectangle) %>%
  summarise(CEnumberOfDominantTrips = sum(CEnumberOfDominantTrips)) %>%
  mutate(pr= CEnumberOfDominantTrips/sum(CEnumberOfDominantTrips, na.rm = TRUE)*100,
         analysis_type = 'sum',
         type_of_threshold = 'none',
         value_of_threshold = NA)-> df

# map
result = choroplethMap_func2(
  df,
  var_name = 'CEnumberOfDominantTrips',
  var_spatial_name = 'CEstatisticalRectangle',
  facet_name = 'CEyear',
  spatial_dataset_name = 'StatRectshp',
  spatial_dataset_var_name = 'ICESNAME',
  spatial_dataset_labels = FALSE,
  saveResults = FALSE,
  outputPath,
  displayInR = TRUE,
  extraShp_name = 'FAOshp',
  var_name_new = NA,
  addToTitle = 'Below 10 meters',
  RCGregion = 'BA'
)

result[[1]]
```

### 10 meteres and above

## Appendix A. Dates of data extraction
## Appendix B. Catch groups
## Appendix C. Mean Landings per stock, put years here
## Appendix D. Summary information of the landings abroad (ton), by country and area
## Appendix E. Glossary for the country codes

