---
title: "Rscript_Diagram"
author: "Karolina"
date: "12/10/2020"
output: word_document
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```


```{r libraries}
library(stringr)
library(data.table)
library(openxlsx)
library(purrr)
library(flextable)
```




```{r cars, results = FALSE}
# Import all functions
for(f in list.files(path="../Scripts/Functions", full.names = T)){
  source(f)
}

# Load the input data
data.file <- "../Metier_data_format_Example_test_input.csv"
input.data <- loadInputData(data.file)

```


```{r refList, results = FALSE}
# Load reference lists
url <- "https://github.com/ices-eg/RCGs/raw/master/Metiers/Reference_lists/AreaRegionLookup.csv"
area.list <- loadAreaList(url)
url <- "https://github.com/ices-eg/RCGs/raw/master/Metiers/Reference_lists/Metier%20Subgroup%20Species%202020.xlsx"
species.list <- loadSpeciesList(url)
url <- "https://github.com/ices-eg/RCGs/raw/master/Metiers/Reference_lists/RDB_ISSG_Metier_list.csv"
metier.list <- loadMetierList(url)
url <- "../Reference_lists/Code-ERSGearType-v1.1.xlsx"
gear.list <- loadGearList(url)
assemblage.list <- unique(c(species.list$species_group, species.list$dws_group))
assemblage.list <- assemblage.list[!is.na(assemblage.list)]
```

# R script 

The script developed to assign metiers based on several variables is called script_metiers_test.R. 

## Prerequisites 

The packages required to run the script are, 

* stringr
* data.table
* openxlsx
* purr

as well as auxiliary information described in sections XXX and a set of functions developed to facilitate the readability of the script. These functions are descripted below in detail. 

* loadInputData.R : reads the Input file provided it's in csv format
* loadAreaList.R : reads the [RCG area file](https://github.com/ices-eg/RCGs/raw/master/Metiers/Reference_lists/AreaRegionLookup.csv) from the Github repository 
* loadSpeciesList.R : reads the [RCG species file](https://github.com/ices-eg/RCGs/raw/master/Metiers/Reference_lists/Metier%20Subgroup%20Species%202020.xlsx) from the Github repository
* loadMetierList.R : reads the [RCG metier file](https://github.com/ices-eg/RCGs/raw/master/Metiers/Reference_lists/RDB_ISSG_Metier_list.csv) from the Github repository
* loadGearList.R : reads the Gear file from ??
* getMeasure.R
* getMetier.R
* getMetierLvl5FromPattern.R

## Data 

The data used as an input should be a csv file format as described in detail in section 2 of the report (Input format for transversal data). The first X rows of the example data set are shown below for clarity. 

* REMOVE THIS IF OUTPUT IS NOT PDF * 

```{r inputdataTab}
input.data$year <- as.character(input.data$year)
ft <- flextable(head(input.data)) %>%
  theme_alafoli() %>% autofit()
ft
```


## Code


```{r prepInput1}
# Prepare input data
input.data[,EUR:=as.numeric(EUR)]
input.data[,KG:=as.numeric(KG)]
```

First the selection column is split between selection type, if any selection panel, and mesh size. 

```{r prepInput2, echo = TRUE}
input.data[,c("selection_type","selection_mesh"):=data.table(str_split_fixed(selection,"_",2))]
input.data[,selection_type:=ifelse(selection_type=="",NA,selection_type)]
input.data[,selection_mesh:=ifelse(selection_mesh=="",NA,selection_mesh)]
```

```{r prepInputTab}
flextable(subset(input.data, !is.na(selection)), col_keys = c("selection", "selection_type", "selection_mesh")) %>%
  theme_alafoli() %>% autofit()
```


The RCG area is assigned based on the Division or subdivision of the input data. 

```{r mergeRCGarea, echo = TRUE}
input.data <- merge(input.data, area.list, all.x = T, by = "area")
input.data[is.na(RCG) & substr(area,1,2) %in% c("31","34","41","47","51","57","58","87"),RCG:="LDF"]
input.data[is.na(RCG) & substr(area,1,2) == "37",RCG:="MED"]
```

```{r mergeRCGareaTab}
flextable(head(input.data), col_keys = c("area", "RCG", "Description")) %>%
  theme_alafoli() %>% autofit()
```

Next step is assigning the target assemblage, depending on the species, and indicating if they belong to the Deep Water Species (DWS) group.

```{r mergeSpecies, echo = TRUE}
input.data <- merge(input.data, species.list, all.x = T, by = "FAO_species")
```

```{r mergeSpeciesTab} 
flextable(tail(input.data), col_keys = c("FAO_species", "species_group", "dws_group")) %>%
  theme_alafoli() %>% autofit()
```


```{r sequence}
sequence.def <- c("Country","year","vessel_id","vessel_length","trip_id","haul_id",
                  "fishing_day","area","ices_rectangle","gear","mesh","selection",
                  "registered_target_assemblage")
# Calculate group totals for each sequence
input.data[,":="(seq_group_KG = sum(KG, na.rm = T),
        seq_group_EUR = sum(EUR, na.rm = T)),
  by=c(sequence.def,"species_group")]
```

