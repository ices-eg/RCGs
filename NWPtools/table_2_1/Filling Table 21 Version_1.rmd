---
title: "R script to construct Table 2.1 by country"
author: Joel Vigneau, with the collaboration of Matt Elliott, Jon Elson, Kirsten Birch   Hakansson,
  Marie Storr-Paulsen, Nuno Prista, Katja Ringhdal, Lies Vansteenbrugge, Sieto Verver, Manon Troucelier
date: "July 2021"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Filling of the EU-MAP table 1A requires to report on country shares of landings and shares of EU TAC when relevant, for all the stocks listed in table 1A of the EU-MAP Regulation (EU Decision 1254/2016). This process necessitates to gather information on landings and EU TAC from an official database, namely EUROSTAT for EU landings and MARE/FIDES for EU TAC. 

Two datasets were added to complete the references, (1) the Nephrops FU landings provided by ICES and (2) the Mediterranean and Black Sea landings fisgures put together by 2016 RCM Mediterranean and Black Sea.

First of all, the datasets listed above contain information from all EU Member States, which means that the script has the potential to be used by all Member States, and by STECF for control of the NWP submitted for 2017. 


## Setting the parameters for the analysis
The variables needed for the work are the working directory, the country code (2-letter code) and the reference years 

```{r echo=FALSE}
######################################################
##        USER CHOICE (START)                       ##
######################################################
#
pathIn     <-    'Q:/mynd/RCM/RCGs/NWPtools/table_2_1/NWP table 2.1'
pathOut    <-    paste(pathIn,'outputs',sep='/')
whatGoesIn <-    list(EUROSTAT      =   FALSE, 
                      FIDES         =   FALSE, 
                      NationalStats =   FALSE,
                      RCGstats      =   TRUE)  # Flag to inform on which source to be used (FIDES=FALSE means the system wil use a public DB instead)
CTRY       <-    'DK'
refYears   <-    2017:2019
#
######################################################
##        USER CHOICE (END)                         ##
######################################################
```

```{r warning=FALSE}
  library(tidyr)
  library(readxl)
  #library(COSTeda) #only for national statistics import and the function which transform ICES rectangle in ICES area
  setwd('.')
  source(paste("Q:/mynd/RCM/RCGs/NWPtools/table_2_1",'Filling Table 21 functions.r',sep='/'))
```
## Importing the datasets
The list of datasets are the following :

1. Landings and TAC shares files: 
  + EUROSTAT landings files: http://ec.europa.eu/eurostat/web/fisheries/data/database
  + MARE/FIDES TAC file: https://webgate.ec.europa.eu/fides/index.cfm
 
```{r}
#Importation of all input files
if (whatGoesIn$EUROSTAT) EURO <- loadEurostat(pathIn)
if (whatGoesIn$FIDES) TAC  <- loadFides(pathIn, ctry = c(CTRY,'UE'), years=refYears+1)  #these are the only FIDES files I have!
if (whatGoesIn$NationalStats) NAT  <- loadNational(pathIn = 'C:/_PROGRAMME/DCF/2021/CREDO/BUM_stats/Input_data/ObsDeb', years=refYears)  
if (whatGoesIn$RCGstats) RCG <- loadRCG("Q:/mynd/RCM/RCGs/NWPtools/table_2_1/NWP table 2.1")
```

2. Reference tables:
  + EuroStat Geo.def: full names of countries
  + ASFIS file : FAO species naming and coding
  + Linkage table mirroring EU-MAP Table 1A naming of species and stock area, and lining to EUROSTAT and MARE/FIDES species and area naming

```{r}
GEO     <- read.table(paste(pathIn,'geo.def',sep='/'),header=TRUE,sep=";", as.is=TRUE)
GEO <- GEO[-1,] #EU (27MS) instead of EU (28MS)
ASFIS   <- read.table(paste(pathIn,'ASFIS_sp_Feb_2018.txt',sep='/'), header=TRUE, sep="\t", as.is=TRUE)
table_2.1 <- read.csv(paste(pathIn,'EUMAP_Table_2_1_Linkage_EUROSTAT and EC_TAC_version_2021_final_v02.csv',sep='/'), sep=';', header=TRUE, as.is=TRUE, encoding='UTF-8') #New
```

## data.frame preparation
The country names are matching between GEO and TAC data.frame, except for UK, so the following lines enables the full match.

```{r warning = FALSE}
#TAC$Level.Description[substring(TAC$Level.Description,1,3) %in% 'U.K'] <- 'United Kingdom'
```
The TAC dataset is well structured and thus ready for the analysis.

```{r warning = FALSE}
names(GEO)[2] <- "Country"
GEO$geo <- toupper(GEO$geo) #2-letter code should be in capitals

if (whatGoesIn$EUROSTAT){
SRG <- strsplit(as.character(EURO$species.fishreg.unit.geo.time),split=",")
SRG.m <- matrix(unlist(SRG), ncol=4, byrow=TRUE)
coln <- sapply(refYears, function(x) which(grepl(x,names(EURO))))
EUROS <- data.frame(X3A_CODE = SRG.m[,1], area = SRG.m[,2], geo = SRG.m[,4],
                  Y1 = EURO[,coln[1]], Y2 = EURO[,coln[2]], Y3 = EURO[,coln[3]])
EUROS <- merge(EUROS, GEO, all.x=TRUE)
EUROS$Y1 <- as.numeric(as.character(EUROS$Y1))
EUROS$Y2 <- as.numeric(as.character(EUROS$Y2))
EUROS$Y3 <- as.numeric(as.character(EUROS$Y3))
ind <- which(is.na(EUROS$Country))
if (length(ind) >0) EUROS <- EUROS[!is.na(EUROS$Country),]
EUROS <- merge(EUROS, ASFIS[,c(3:6)], all.x=TRUE)
}
```
Let's have a look at the workable structure of EuroStat dataset. Note that Y1, Y2 and Y3 are the 3-year period demanded, and the presence of NA's. The assumption made here (further in the Construction of the table section) is to exclude NA from the average, i.e. like if MS had omitted to report, instead of a NA which would mean 0. The confusion comes because lots of 0 are reported in EuroStat (implicitely meaning that NA is not a 0). This point may be subject of a STECF agreement or suggestion for modification.
```{r warning = FALSE}
if (whatGoesIn$EUROSTAT){
head(EUROS,3)
}
```

RCG data

```{r warning = FALSE}

if (whatGoesIn$RCGstats) {
RCGS <- RCG[RCG$Year %in% refYears,]
RCGS <- merge(RCGS, GEO, all.x = TRUE, by.x = "FlagCountry", by.y = "Level.Description" )
RCGS <- RCGS[with(RCGS, order(Year)), ]
RCGS <- pivot_wider(RCGS, names_from = Year, values_from = OfficialLandingCatchWeight_ton)
ind <- which(is.na(RCGS$Country))
if (length(ind) >0) RCGS <- RCGS[!is.na(RCGS$Country),]
RCGS <- merge(RCGS, ASFIS[,c(3:6)], all.x=TRUE, by.x = "Species", by.y = "Scientific_name")

colnames(RCGS)[c(1,4,7:9, 2)] = c('Scientific_name','area','Y1', 'Y2', 'Y3', 'Level.Description')

RCGS = RCGS[,c('X3A_CODE', 'geo', 'area', 'Y1', 'Y2', 'Y3',"Country", 'Level.Description', 'Scientific_name','English_name', 'French_name')]
}

test <- distinct(RCGS, X3A_CODE, Scientific_name)

```



## Construction of the table
The main part of the code

```{r}
#########################################################
##                                                     ##
##             CONSTRUCTION OF THE TABLE               ##
##                                                     ##
#########################################################
# Preamble
T21 <- data.frame()
tabControl <- data.frame(spp=NA, geo=NA, area=NA, year=NA)
if (whatGoesIn$EUROSTAT) {tabControl$EURO.CTRY=NA; tabControl$EURO.EU=NA}
if (whatGoesIn$FIDES)    {tabControl$FIDES.CTRY=NA;  tabControl$FIDES.EU = NA; tabControl$FIDES.SHARE=NA}
if (whatGoesIn$NationalStats) tabControl$NAT.CTRY=NA
if (whatGoesIn$RCGstats) {tabControl$RCG.CTRY=NA; tabControl$RCG.EU=NA}
colnames(table_2.1)[1]<- "region"
colnames(table_2.1)[7]<- "FIDES_stockID"

# From EUROSTAT
# ---------------------------------------------------
for (i in 1:nrow(table_2.1)) {
  #
  # -----> start here with a value of i for a line by line check  <-------
  #
  if (whatGoesIn$EUROSTAT) {
  ctry2 <- GEO$Country[GEO$geo %in% CTRY]
	reg <- strsplit(as.character(table_2.1$areaBis[i]), split=',')
  EUR <- EUROS[EUROS$Scientific_name %in% table_2.1$latinName[i] & tolower(EUROS$area) %in% tolower(reg[[1]]),]
  ind <- which(EUR$Level.Description %in% 'GBR')
  if (length(ind) >0) EUR <- EUR[-ind,]  # UK is not in EU27, so when only UK declares a stock the line EU27 is missing and this case is treated under nrow(EUR) == 0
  if (nrow(EUR) == 1) if (EUR$Country %in% 'European union (28 MS)') EUR <- EUR [-1,]
  
   if (nrow(EUR) == 0) {
   EUR <- data.frame(X3A_CODE = rep(table_2.1$X3A_CODE[i],2), geo = c(CTRY,'EU27_2020'), area = rep(table_2.1$area[i],2),
                     Y1=rep(NA,2), Y2=rep(NA,2),Y3=rep(NA,2),
                     Country=c(ctry2,'European union (27 MS)'), source=FALSE,
                     Level.Description = GEO$Level.Description[GEO$geo %in% c(CTRY,'EU27_2020')], 
                     Scientific_name = rep(table_2.1$latinName[i],2), English_name=rep(NA,2), French_name=rep(NA,2))
   } else {
    EUR$source <- TRUE
   }
  
 	EUR$MOY <- apply(EUR[,4:6],1,mean,na.rm=TRUE)
	EUR_C <- EUR[EUR$geo %in% CTRY,]
	# if there's info for CTRY
	if (nrow(EUR_C) == 0) {
   EUR_C <- data.frame(X3A_CODE = table_2.1$X3A_CODE[i], geo = CTRY, area = table_2.1$area[i],
                     Y1=NA, Y2=NA,Y3=NA, Moy=NA, Country=ctry2, source=FALSE,
                     Level.Description = GEO$Level.Description[GEO$geo %in% CTRY], 
                     Scientific_name = table_2.1$latinName[i], English_name=NA, French_name=NA)
  }

	EUR_UE <- EUR[EUR$geo %in% 'EU27_2020',]
	if(EUR_UE$source[1]) { sourceEU <- 'Eurostat'
	} else {
	  sourceEU <- '-'
	}
	if(EUR_C$source[1]) { sourceNat <- 'Eurostat'
	} else {
	  sourceNat <- '-'
	}

	# Identification of reference years (Eurostat may be missing the most recent years)
	N <- nrow(EUR[EUR$geo %in% CTRY,])
	yrRange <- apply(is.na(EUR_C[,c('Y1','Y2','Y3')]),2,sum)
	names(yrRange) <- substring(names(EURO)[coln],2,5)
	referenceYears <- paste(names(which(yrRange<N)),collapse = ', ')
 #Construction of the table 2.1 line of information
	T1 <- data.frame(MS=CTRY, refYears=referenceYears,region=table_2.1$region[i],
		RFMO=table_2.1$RFMO[i], spp=table_2.1$latinName[i], area = table_2.1$area[i], landings=NA,
		sourceNat=sourceNat, TAC=NA,shareLanding=NA,sourceEU=sourceEU, thresh='None', regCoord=NA,
		coveredLength=NA, selectedBio=NA, comments=NA, natStats=NA)
	
	if (sum(is.na(EUR_C$MOY)) < nrow(EUR_C)) {
		T1$landings <- sum(EUR_C$MOY,na.rm=TRUE)
		T1$shareLanding <- T1$landings/sum(EUR_UE$MOY,na.rm=TRUE)
		} else {
		T1$landings <- 0
		T1$shareLanding <- 0
		}
	#construction of the control table
	tbC <- data.frame(spp=table_2.1$latinName[i], geo=rep(CTRY, each=3), area=table_2.1$area[i], year=refYears,
	                  EURO.CTRY=apply(EUR_C[,c('Y1','Y2','Y3')],2,sum,na.rm=TRUE),
	                  EURO.EU=  apply(EUR_UE[,c('Y1','Y2','Y3')],2,sum,na.rm=TRUE)) 
} # end of the part of whatGoesIn$EUROSTAT
  

# RCG - Marta, update 13.08.2021
# ----------------------------------------------
# 
	
  if (whatGoesIn$RCGstats) {
      ctry2 <- GEO$Country[GEO$geo %in% CTRY]
      RCGS$area = gsub('[.]', '_', RCGS$area)
      
      reg <- strsplit(as.character(table_2.1$areaRDB[i]), split = ',')
      species <- strsplit(as.character(table_2.1$latinNameJoin[i]), split = ',')
      
      RCGS2 <-
        RCGS[RCGS$Scientific_name %in% species[[1]] &
               tolower(RCGS$area) %in% tolower(reg[[1]]), ]
      ind <- which(RCGS2$Level.Description %in% 'GBR')
      
      if (length(ind) > 0)
        RCGS2 <-
        RCGS2[-ind, ]  # UK is not in EU27, so when only UK declares a stock the line EU27 is missing and this case is treated under nrow(EUR) == 0
      if (nrow(RCGS2) == 1)
        if (RCGS2$Country %in% 'European union (28 MS)')
          RCGS2 <- RCGS2 [-1, ]
      if (nrow(RCGS2) == 0) {
        RCGS2 <-
          data.frame(
            X3A_CODE = rep(table_2.1$X3A_CODE[i], 2),
            geo = c(CTRY, 'EU27_2020'),
            area = rep(table_2.1$area[i], 2),
            Y1 = rep(NA, 2),
            Y2 = rep(NA, 2),
            Y3 = rep(NA, 2),
            Country = c(ctry2, 'European union (27 MS)'),
            source = FALSE,
            Level.Description = GEO$Level.Description[GEO$geo %in% c(CTRY, 'EU27_2020')],
            Scientific_name = rep(table_2.1$latinName[i], 2),
            English_name = rep(NA, 2),
            French_name = rep(NA, 2)
          )
      } else {
        RCGS2$source <- TRUE
      }
      
      RCGS2$MOY <- apply(RCGS2[, 4:6], 1, mean, na.rm = TRUE)
      RCGS2_C <- RCGS2[RCGS2$geo %in% CTRY, ]
      # if there's info for CTRY
      if (nrow(RCGS2_C) == 0) {
        RCGS2_C <-
          data.frame(
            X3A_CODE = table_2.1$X3A_CODE[i],
            geo = CTRY,
            area = table_2.1$area[i],
            Y1 = NA,
            Y2 = NA,
            Y3 = NA,
            Moy = NA,
            Country = ctry2,
            source = FALSE,
            Level.Description = GEO$Level.Description[GEO$geo %in% CTRY],
            Scientific_name = table_2.1$latinName[i],
            English_name = NA,
            French_name = NA
          )
      }
      
  if(RCGS2$source[1]) { sourceEU <- 'RCG'
	} else {
	  sourceEU <- '-'
	}
	if(RCGS2_C$source[1]) { sourceNat <- 'RCG'
	} else {
	  sourceNat <- '-'
	}
      
      N <- nrow(RCGS2_C)
      yrRange <- apply(is.na(RCGS2_C[, c('Y1', 'Y2', 'Y3')]), 2, sum)
      names(yrRange) <- refYears
      referenceYears <- paste(names(which(yrRange < N)), collapse = ', ')
      #Construction of the table 2.1 line of information
      T1 <-
        data.frame(
          MS = CTRY,
          refYears = referenceYears,
          region = table_2.1$region[i],
          RFMO = table_2.1$RFMO[i],
          spp = table_2.1$latinName[i],
          area = table_2.1$area[i],
          landings = NA,
          sourceNat = sourceNat,
          TAC = NA,
          shareLanding = NA,
          sourceEU = sourceEU,
          thresh = 'None',
          regCoord = NA,
          coveredLength = NA,
          selectedBio = NA,
          comments = NA,
          natStats = NA
        )
      
      if (sum(is.na(RCGS2_C$MOY)) < nrow(RCGS2_C)) {
        T1$landings <- sum(RCGS2_C$MOY, na.rm = TRUE)
        T1$shareLanding <- T1$landings / sum(RCGS2$MOY, na.rm = TRUE)
      } else {
        T1$landings <- 0
        T1$shareLanding <- 0
      }
    
      	tbC <- data.frame(spp=table_2.1$latinName[i], geo=rep(CTRY, each=3), area=table_2.1$area[i], year=refYears,
	                  RCG.CTRY=apply(RCGS2_C[,c('Y1','Y2','Y3')],2,sum,na.rm=TRUE),
	                  RCG.EU=  apply(RCGS2[,c('Y1','Y2','Y3')],2,sum,na.rm=TRUE)) 


    } #end of the part of whatGoesIn$RCGstats


# From FIDES
# -----------------------------------------------------------------------
  if (whatGoesIn$FIDES) {
		aa<-strsplit(as.character(table_2.1$FIDES_stockID[i]),split=',')[[1]]
	  spp <- strsplit(as.character(table_2.1$X3A_CODE[i]), split=',')[[1]]
		TACii <- TAC[TAC$Species %in% spp & TAC$Area %in% aa,]
		names(TACii)[c(1,8,10)] <- c('Level.Description','adaptedQuota','Catches')
		TACii <- merge(TACii, GEO[,c(1,3)], all.x=TRUE)
		names(TACii)[16] <- 'CTRY'
		N <- nrow(TACii)
		flagTAC <- !(table_2.1$FIDES_stockID %in% c('No TAC',''))

		if (flagTAC[i] & N>0) {
		if (length(aa)>1) {
			TACii <- aggregate(list(adaptedQuota = TACii$adaptedQuota, Catches=TACii$Catches), 
				by=list(CTRY = TACii$CTRY, year=TACii$year), sum, na.rm=TRUE)
		  }
		# 
		TACim <- aggregate(list(adaptedQuota = TACii$adaptedQuota, Catches=TACii$Catches), 
				by=list(CTRY = TACii$CTRY), mean, na.rm=TRUE)
		
		ind.ct <- TACim$adaptedQuota[which(TACim$CTRY %in% CTRY)]
		ind.eu <- TACim$adaptedQuota[TACim$CTRY %in% 'EU27_2020']
		sourceTAC <- c('FIDES','Public TAC DB')
		names(sourceTAC) <- c('TRUE','FALSE')
		if (length(ind.ct) == 1) {T1$TAC <- ind.ct/ind.eu; T1$sourceEU <- sourceTAC[paste0(isFides)]}
		T1$comments<-NA
		#with the actual French only FIDES file, this does not work!
		TT <- tapply(TACim$adaptedQuota, TACim$CTRY,sum,na.rm=TRUE)/TACim$adaptedQuota[TACim$Ctry %in% 'EEC']
		TT <-  TT[names(TT) %in% GEO$Level.Description]  #Keep only the EU countries to calculate the 25% rule
		if (!(is.na(T1$TAC)) & T1$TAC <0.1 & T1$TAC>0) 	T1$comments <- sum(TT[which(TT<0.1)])
		if (!(is.na(T1$comments)) & T1$comments >=.25)	{
			print(T1)
			print(TT[TT<.1])
			cat('\n')
		}
		TACii$CTRY <- factor(TACii$CTRY,levels=c('EU27_2020',CTRY))
		fides.quota <- tapply(TACii$adaptedQuota,list(TACii$year,TACii$CTRY), mean,na.rm=TRUE)
		tbC2 <- data.frame(spp=table_2.1$latinName[i], geo=rep(CTRY,3), area=table_2.1$area[i], year=sort(unique(TACii$year)),
	                  FIDES.CTRY=fides.quota[,CTRY],  FIDES.EU = fides.quota[,'EU27_2020'], 
	                  FIDES.SHARE= fides.quota[,CTRY]/fides.quota[,'EU27_2020']) 
    tbC <- merge(tbC, tbC2, all=TRUE)
		} else {
		  tbC$FIDES.CTRY <- tbC$FIDES.EU <- tbC$FIDES.SHARE <- NA
	  }#end of the initial condition on TAC
  } #end of the part of whatGoesIn$FIDES
  
  
# National statistics
# ----------------------------------------------
# 
  if (whatGoesIn$NationalStats) {
    # nat stats are not organised like EUROSTAT, if seeked area is '27_2' and is '27_2_a' then it won't match  
    # how to deal in such a case with search of landings in areas like '27_4' and '27_7-d' ?
    tmp <- data.frame()
    lnc <- split(reg[[1]],nchar(reg[[1]]))
	  spp <- strsplit(as.character(table_2.1$X3A_CODE[i]), split=',')[[1]]

    for (j in 1:length(lnc)) {
        ncha <- as.numeric(names(lnc[j]))
     		tmp_j <- NAT[NAT$ESP_COD_FAO %in% spp & substring(NAT$SECTEUR,1,ncha) %in% lnc[[j]],]
        tmp <- rbind.data.frame(tmp, tmp_j)
    }
	
		nat.ctry <- round(tapply(tmp$CAPTURES_KG,tmp$ANNEE,sum,na.rm=TRUE)/1000,0)
		T1$natStats <- round(mean(nat.ctry,na.rm=TRUE),0)
		if (nrow(tmp)==0 ) {
		  tbC3 <- data.frame(spp=table_2.1$latinName[i], geo=CTRY, area=table_2.1$area[i], year=refYears, NAT.CTRY=NA)
		} else {
		tbC3 <- data.frame(spp=table_2.1$latinName[i], geo=CTRY, area=table_2.1$area[i], year=names(nat.ctry), NAT.CTRY=nat.ctry)
		}
  	tbC <- merge(tbC, tbC3, all=TRUE)
  } #end of the part of whatGoesIn$NationalStats

# ----------------------------------------------
# 
T21 <- rbind.data.frame(T21, T1)

tabControl <- rbind.data.frame(tabControl, tbC)
	
#Some formatting on the final data.frame (T21)		
	T21$thresh <- as.character(T21$thresh)
	#Threshold ruling specified like the EU Reg
	T21$thresh[T21$TAC <.1] <- 'TAC < 10%'  #rule (a)
	T21$thresh[is.na(T21$TAC) & T21$shareLanding <.1] <- 'Landings < 10%' #rule (b)
	T21$thresh[T21$landings >0 & T21$landings < 200] <- 'Landings < 200t.'  #rule (c)

	
}  #end of the loop on table_2.1 rows
```

##Formatting
```{r}
T2_1 <- T21
ind <- which(T2_1$landings ==0 & T2_1$natStats>0)
T2_1$landings[ind] <- T2_1$natStats[ind]
T2_1$sourceNat <- as.character(T2_1$sourceNat)
T2_1$sourceNat[ind] <- 'National statistics'

ind <- which(1-T21$landings/T21$natStats>0.5)
T2_1$landings[ind] <- T2_1$natStats[ind]
T2_1$sourceNat <- as.character(T2_1$sourceNat)
T2_1$sourceNat[ind] <- 'National statistics'

T2_1$landings <- round(T2_1$landings,0)
T2_1$natStats <- round(T2_1$natStats,0)
T2_1$landings[T2_1$landings == 0] <- 'None'
T2_1$TAC <- paste(round(100*T2_1$TAC,0),'%',sep='')
T2_1$TAC[T2_1$TAC %in% c('NA%','NaN%','Inf%')] <- 'None'
T2_1$shareLanding <- paste(round(100*T2_1$shareLanding,0),'%',sep='')
T2_1$shareLanding[T2_1$shareLanding %in% c('NA%','NaN%','Inf%')] <- 'None'
T2_1$thresh[T2_1$landings %in% 'None' & T2_1$TAC %in% 'None'] <- T2_1$shareLanding[T2_1$landings %in% 'None' & T2_1$TAC %in% 'None'] <- 'None'
ind <- which(T2_1$comments>.25)
T2_1$comments <- paste(round(100*T2_1$comments,0),'%',sep='')
T2_1$comments[T2_1$comments<.25] <- '-'
T2_1$comments[T2_1$comments %in% c('NA%','NaN%','Inf%')] <- '-'
T2_1$comments[ind] <- paste('Sum of MS shares <10% = ',T2_1$comments[ind],sep='')
T2_1[!ind]<-'-'
T2_1$coveredLength <- '-'
T2_1$selectedBio <- '-'
T2_1$thresh[T2_1$landings %in% 'None'] <- 'None'
T2_1$coveredLength[!(T2_1$landings %in% 'None')] <- 'Y'
T2_1$coveredLength[nchar(T2_1$thresh) >4] <- 'N'
T2_1[T2_1$RFMO %in% c('ICCAT','IOTC','WCPFC') & T2_1$landings>0,c('coveredLength','thresh')] <- c('Y','None')
T2_1[T2_1$spp %in% 'Anguilla anguilla' & T2_1$landings !='None',c('coveredLength','thresh')] <- c('Y','None')
T2_1[T2_1$spp %in% 'Nephrops norvegicus' & !(grepl('TAC', T2_1$area)),'TAC'] <- 'None'
T2_1$refYears <- as.character(T2_1$refYears)
T2_1$refYears[T2_1$sourceNat %in% 'National statistics'] <- paste(range(refYears),collapse='-')
nchaY <- unlist(lapply(strsplit(T2_1$refYears,split=','),length))
T2_1$refYears[nchaY == 3] <- unlist(lapply(T2_1$refYears[nchaY == 3], function(x) paste(range(as.numeric(strsplit(x,split=',')[[1]])), collapse='-')))
T2_1$regCoord <- 'N'
T2_1$regCoord[T2_1$landings %in% 'None'] <- '-'

```

## Export of Table 2.1
the rule sum of quotas for coutries <10% (less or more than 25%) is noted in the comments column
The national statistics (when exists) are on an extra column
```{r}
write.table(T2_1, file=paste(pathOut,paste(CTRY,'_table2_1_filled.csv',sep=''),sep='/'), sep=';',row.names=FALSE, quote=FALSE)
write.table(tabControl, file=paste(pathOut,paste(CTRY,'_table2_1_control.csv',sep=''),sep='/'), sep=';',row.names=FALSE, quote=FALSE)
```





```

